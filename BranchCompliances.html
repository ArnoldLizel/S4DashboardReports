<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Branch Compliances - Philippine Navy</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    body {
        background-image: url('image/bg2.jpg');
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        background-repeat: no-repeat;
        min-height: 100vh;
    }

    .container {
        background-color: rgba(255, 255, 255, 0.95); 
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; color: #1f2937; line-height: 1.6; min-height: 100vh; padding: 1.5rem; }
    .container { max-width: 1800px; margin: 0 auto; }
    h1 { color: #0b1a3a; font-weight: 700; font-size: 2rem; margin-bottom: 1.5rem; }

    .header-wrapper { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
    .action-buttons { display: flex; gap: 1rem; flex-wrap: wrap; }
    .btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; font-size: 0.875rem; font-weight: 600; border-radius: 0.5rem; border: none; cursor: pointer; transition: all 0.3s ease; text-decoration: none; white-space: nowrap; }
    .btn-save { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
    .btn-save:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); }
    .btn-print { background: linear-gradient(135deg, #0b1a3a 0%, #1e3a8a 100%); color: white; }
    .btn-test { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
    
    .status-indicator { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 600; }
    .status-connected { background: #d1fae5; color: #065f46; }
    .status-error { background: #fee2e2; color: #991b1b; }
    .status-loading { background: #dbeafe; color: #1e40af; }

    .kanban-board { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.25rem; margin-top: 1.5rem; }
    .kanban-column { background: white; border-radius: 0.75rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); overflow: hidden; display: flex; flex-direction: column; max-height: calc(100vh - 220px); }

    .kanban-column.branch-1 { border-top: 4px solid #10b981; }
    .kanban-column.branch-2 { border-top: 4px solid #f59e0b; }
    .kanban-column.branch-3 { border-top: 4px solid #ef4444; }
    .kanban-column.branch-4 { border-top: 4px solid #3b82f6; }
    .kanban-column.branch-5 { border-top: 4px solid #8b5cf6; }

    .column-header { padding: 1rem 1.25rem; font-weight: 700; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f3f4f6; }
    .column-header.branch-1 { background: #d1fae5; color: #065f46; }
    .column-header.branch-2 { background: #fef3c7; color: #92400e; }
    .column-header.branch-3 { background: #fee2e2; color: #991b1b; }
    .column-header.branch-4 { background: #dbeafe; color: #1e3a8a; }
    .column-header.branch-5 { background: #f3e8ff; color: #5b21b6; }

    .branch-avatar-container { position: relative; width: 48px; height: 48px; flex-shrink: 0; }
    .branch-avatar { width: 48px; height: 48px; border-radius: 0.5rem; object-fit: cover; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.1); background: white; display: flex; align-items: center; justify-content: center; font-weight: 700; cursor: pointer; }
    .avatar-upload-btn { position: absolute; top: -4px; right: -4px; width: 20px; height: 20px; background: #3b82f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; cursor: pointer; }
    .file-input { display: none; }
    .task-count { background: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; }
    .column-body { padding: 1rem; overflow-y: auto; flex: 1; }
    .task-card { background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-bottom: 0.75rem; cursor: pointer; transition: 0.2s; }
    .task-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .task-title { font-weight: 600; font-size: 0.9rem; margin-bottom: 0.5rem; }
    .task-content { font-size: 0.8rem; color: #6b7280; }
    .task-status { font-size: 0.7rem; font-weight: bold; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; }
    .task-status.completed { background: #d1fae5; color: #065f46; }
    .task-status.not-completed { background: #fef3c7; color: #92400e; }
    .add-task-btn { width: 100%; padding: 10px; border: 2px dashed #d1d5db; border-radius: 8px; color: #6b7280; cursor: pointer; font-weight: 600; background: white; }
    .add-task-btn:hover { background: #f9fafb; border-color: #9ca3af; }
    
    .notification { position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 8px; color: white; z-index: 1000; animation: slideIn 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .success { background: #10b981; }
    .error { background: #ef4444; }
    .info { background: #3b82f6; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    
    @media print {
        .no-print { display: none !important; }
        .kanban-board { display: block; }
        .kanban-column { page-break-inside: avoid; margin-bottom: 1rem; }
    }
</style>
</head>
<body>

<div class="container">
  <div class="header-wrapper">
    <div>
      <h1>üìã Branch Compliances</h1>
      <div id="statusIndicator" class="status-indicator status-loading">
        <span id="statusIcon">‚è≥</span>
        <span id="statusText">Checking connection...</span>
      </div>
    </div>
    <div class="action-buttons no-print">
      <button class="btn btn-test" id="testBtn"><span>üîß</span><span>Test Connection</span></button>
      <button class="btn btn-save" id="saveBtn"><span>üíæ</span><span>Save All Data</span></button>
      <button class="btn btn-print" id="printBtn"><span>üñ®Ô∏è</span><span>Print</span></button>
    </div>
  </div>

  <div class="kanban-board" id="kanbanBoard"></div>
</div>

<script>
(function() {
  const SUPABASE_URL = "https://jdzfxfriydakuqegtahq.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkemZ4ZnJpeWRha3VxZWd0YWhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwODU0MTEsImV4cCI6MjA3NjY2MTQxMX0.8uuX1PUSKOg03AuZeJJ5HxSUhM-gqapTclMn2A3tD4U";
  
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const branches = [
    { name: "Admin and Supply Branch", color: "branch-1", avatar: "AS", image: null },
    { name: "Facility and Maintenance Branch", color: "branch-2", avatar: "FM", image: null },
    { name: "Budget and Fiscal Branch", color: "branch-3", avatar: "BF", image: null },
    { name: "Mobility and POL Branch", color: "branch-4", avatar: "MP", image: null },
    { name: "Special Branch", color: "branch-5", avatar: "SB", image: null }
  ];

  const kanbanBoard = document.getElementById("kanbanBoard");
  const saveBtn = document.getElementById("saveBtn");
  const printBtn = document.getElementById("printBtn");
  const testBtn = document.getElementById("testBtn");
  const currentYear = new Date().getFullYear().toString();
  let notes = {};

  function initializeNotes() {
    notes = {};
    branches.forEach(function(b) {
      notes[b.name] = [];
    });
  }
  initializeNotes();

  function updateStatus(status, text, icon) {
    const indicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    const statusIcon = document.getElementById('statusIcon');
    
    indicator.className = 'status-indicator status-' + status;
    statusText.textContent = text;
    statusIcon.textContent = icon;
  }

  function showNotification(message, type) {
    const n = document.createElement('div');
    n.className = 'notification ' + (type || 'success');
    n.textContent = message;
    document.body.appendChild(n);
    setTimeout(function() {
      n.remove();
    }, 4000);
  }

  async function testConnection() {
    updateStatus('loading', 'Testing connection...', '‚è≥');
    showNotification('Testing database connection...', 'info');
    
    try {
      const result = await supabase.from('branch_compliances').select('count', { count: 'exact', head: true });
      
      if (result.error) {
        throw result.error;
      }
      
      updateStatus('connected', 'Connected to database', '‚úÖ');
      showNotification('‚úÖ Database connection successful!', 'success');
      console.log('Connection test successful');
    } catch (err) {
      updateStatus('error', 'Connection failed', '‚ùå');
      showNotification('‚ùå Connection failed: ' + err.message, 'error');
      console.error('Connection error:', err);
    }
  }

  function renderKanbanBoard() {
    kanbanBoard.innerHTML = branches.map(function(branch) {
      const branchNotes = notes[branch.name] || [];
      const branchId = branch.name.replace(/\s+/g, '-');
      
      const notesHTML = branchNotes.map(function(note, i) {
        return createTaskCard(note, branch, i);
      }).join('');
      
      return '<div class="kanban-column ' + branch.color + '">' +
        '<div class="column-header ' + branch.color + '">' +
          '<div style="display:flex; align-items:center; gap:10px;">' +
            '<div class="branch-avatar-container">' +
              (branch.image ? 
                '<img src="' + branch.image + '" class="branch-avatar" onclick="triggerUpload(\'' + branch.name + '\')">' :
                '<div class="branch-avatar" onclick="triggerUpload(\'' + branch.name + '\')">' + branch.avatar + '</div>'
              ) +
              '<div class="avatar-upload-btn" onclick="triggerUpload(\'' + branch.name + '\')"><i class="fas fa-camera"></i></div>' +
              '<input type="file" id="upload-' + branchId + '" class="file-input" accept="image/*" onchange="handleImageUpload(event, \'' + branch.name + '\')">' +
            '</div>' +
            '<span>' + branch.name + '</span>' +
          '</div>' +
          '<span class="task-count">' + branchNotes.length + '</span>' +
        '</div>' +
        '<div class="column-body" id="column-' + branchId + '">' +
          notesHTML +
          '<button class="add-task-btn" onclick="addNewTask(\'' + branch.name + '\')">+ Add Task</button>' +
        '</div>' +
      '</div>';
    }).join('');
  }

  function createTaskCard(note, branch, index) {
    if (note.editing) {
      return '<div class="task-card" style="background:#f9fafb; border:2px solid #3b82f6;">' +
        '<input type="text" id="edit-title-' + branch.name + '-' + index + '" class="task-title" value="' + note.title + '" style="width:100%; margin-bottom:5px; padding:0.5rem; border:1px solid #d1d5db; border-radius:0.375rem;">' +
        '<textarea id="edit-content-' + branch.name + '-' + index + '" style="width:100%; font-size:0.8rem; padding:0.5rem; border:1px solid #d1d5db; border-radius:0.375rem; min-height:60px;">' + note.content + '</textarea>' +
        '<select id="edit-status-' + branch.name + '-' + index + '" style="width:100%; margin:5px 0; padding:0.5rem; border:1px solid #d1d5db; border-radius:0.375rem;">' +
          '<option value="Not Completed" ' + (note.status === "Not Completed" ? "selected" : "") + '>Pending</option>' +
          '<option value="Completed" ' + (note.status === "Completed" ? "selected" : "") + '>Completed</option>' +
        '</select>' +
        '<div style="display:flex; gap:5px; margin-top:8px;">' +
          '<button onclick="saveEdit(\'' + branch.name + '\', ' + index + ')" style="background:#10b981; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; font-weight:600;">Save</button>' +
          '<button onclick="cancelEdit(\'' + branch.name + '\', ' + index + ')" style="background:#6b7280; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; font-weight:600;">Cancel</button>' +
        '</div>' +
      '</div>';
    }
    
    return '<div class="task-card">' +
      '<div class="task-title">' + note.title + '</div>' +
      '<div class="task-content">' + note.content + '</div>' +
      '<div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">' +
        '<span class="task-status ' + (note.status === 'Completed' ? 'completed' : 'not-completed') + '">' + note.status + '</span>' +
        '<div class="no-print">' +
          '<span onclick="editTask(\'' + branch.name + '\', ' + index + ')" style="cursor:pointer; margin-right:8px; font-size:1.2rem;">‚úèÔ∏è</span>' +
          '<span onclick="deleteTask(\'' + branch.name + '\', ' + index + ')" style="cursor:pointer; font-size:1.2rem;">üóëÔ∏è</span>' +
        '</div>' +
      '</div>' +
    '</div>';
  }

  window.addNewTask = function(branchName) {
    notes[branchName].push({
      title: "New Task",
      content: "Description...",
      status: "Not Completed",
      editing: true
    });
    renderKanbanBoard();
  };

  window.editTask = function(branchName, index) {
    notes[branchName][index].editing = true;
    renderKanbanBoard();
  };

  window.cancelEdit = function(branchName, index) {
    if (notes[branchName][index].title === "New Task" && notes[branchName][index].content === "Description...") {
      notes[branchName].splice(index, 1);
    } else {
      notes[branchName][index].editing = false;
    }
    renderKanbanBoard();
  };

  window.saveEdit = function(branchName, index) {
    notes[branchName][index].title = document.getElementById('edit-title-' + branchName + '-' + index).value;
    notes[branchName][index].content = document.getElementById('edit-content-' + branchName + '-' + index).value;
    notes[branchName][index].status = document.getElementById('edit-status-' + branchName + '-' + index).value;
    notes[branchName][index].editing = false;
    renderKanbanBoard();
  };

  window.deleteTask = function(branchName, index) {
    if (confirm("Delete this task?")) {
      notes[branchName].splice(index, 1);
      renderKanbanBoard();
    }
  };

  window.triggerUpload = function(branchName) {
    document.getElementById('upload-' + branchName.replace(/\s+/g, '-')).click();
  };

  window.handleImageUpload = function(event, branchName) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(ev) {
        const branch = branches.find(function(br) {
          return br.name === branchName;
        });
        if (branch) {
          branch.image = ev.target.result;
          renderKanbanBoard();
        }
      };
      reader.readAsDataURL(file);
    }
  };

  saveBtn.onclick = async function() {
    saveBtn.disabled = true;
    saveBtn.textContent = 'üíæ Saving...';
    updateStatus('loading', 'Saving data...', '‚è≥');
    
    try {
      const toSave = [];
      branches.forEach(function(b) {
        notes[b.name].forEach(function(n) {
          toSave.push({
            year: currentYear,
            branch: b.name,
            title: n.title,
            content: n.content,
            status: n.status
          });
        });
      });

      console.log('Deleting old records for year:', currentYear);
      const deleteResult = await supabase.from('branch_compliances').delete().eq('year', currentYear);
      
      if (deleteResult.error) {
        throw deleteResult.error;
      }

      if (toSave.length > 0) {
        console.log('Inserting new records:', toSave.length);
        const insertResult = await supabase.from('branch_compliances').insert(toSave);
        
        if (insertResult.error) {
          throw insertResult.error;
        }
      }

      updateStatus('connected', 'Data saved successfully', '‚úÖ');
      showNotification('‚úÖ Data saved successfully!', 'success');
      console.log('Save successful');
    } catch (err) {
      updateStatus('error', 'Save failed', '‚ùå');
      showNotification('‚ùå Error saving: ' + err.message, 'error');
      console.error('Save error:', err);
    }
    
    saveBtn.disabled = false;
    saveBtn.innerHTML = '<span>üíæ</span><span>Save All Data</span>';
  };

  async function loadData() {
    updateStatus('loading', 'Loading data...', '‚è≥');
    
    try {
      console.log('Loading data for year:', currentYear);
      const result = await supabase.from('branch_compliances').select('*').eq('year', currentYear);
      
      if (result.error) {
        throw result.error;
      }

      const data = result.data;
      console.log('Loaded records:', data ? data.length : 0);
      
      if (data) {
        initializeNotes();
        data.forEach(function(r) {
          if (notes[r.branch]) {
            notes[r.branch].push({
              title: r.title,
              content: r.content,
              status: r.status,
              editing: false
            });
          }
        });
        renderKanbanBoard();
        updateStatus('connected', 'Connected to database', '‚úÖ');
      }
    } catch (err) {
      updateStatus('error', 'Failed to load data', '‚ùå');
      showNotification('‚ùå Error loading data: ' + err.message, 'error');
      console.error('Load error:', err);
      renderKanbanBoard();
    }
  }

  testBtn.onclick = testConnection;
  printBtn.onclick = function() {
    window.print();
  };

  loadData();
})();
</script>
</body>
</html>