<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSG Monitoring | Expanded View</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --navy: #0f172a;
            --indigo: #4338ca;
            --slate-200: #e2e8f0;
            --slate-700: #334155;
            --glass: rgba(255, 255, 255, 0.98);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-image: url('image/bg2.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--slate-700);
            padding: 2rem;
            min-height: 100vh;
        }

        .main-wrapper {
            max-width: 1750px; /* Wider container for more horizontal breathing room */
            margin: 0 auto;
            background: var(--glass);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            padding: 2.5rem;
        }

        /* --- SUMMARY SECTION --- */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }
        .summary-card { padding: 1.5rem; border-radius: 8px; color: white; }
        .summary-card .amount { font-size: 1.6rem; font-weight: 800; margin-top: 5px; }
        .card-total { background: var(--navy); }
        .card-svp { background: #2563eb; }
        .card-shop { background: #059669; }
        .card-nego { background: #d97706; }

        /* --- ACTION BAR --- */
        .action-bar {
            background: #f8fafc;
            padding: 1.2rem;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            margin-bottom: 1.5rem;
            border: 1px solid var(--slate-200);
        }

        .search-bar {
            flex-grow: 1;
            max-width: 400px;
            padding: 12px 16px;
            border-radius: 6px;
            border: 1px solid var(--slate-200);
            font-size: 0.95rem;
        }

        /* --- TABLE FIXES FOR OVERLAP --- */
        .table-container { 
            overflow-x: auto; 
            border: 1px solid var(--slate-200);
            border-radius: 8px;
            background: white;
        }

        table { 
            width: 100%; 
            border-collapse: collapse; 
            table-layout: auto; /* Auto layout prevents fixed-width clipping */
            min-width: 1200px; /* Ensures the table doesn't crush on small screens */
        }
        
        thead th {
            background: #f1f5f9;
            padding: 1.2rem 1rem;
            font-size: 0.75rem;
            font-weight: 800;
            text-transform: uppercase;
            color: #64748b;
            border-bottom: 2px solid var(--slate-200);
            text-align: left;
        }

        /* FIXED WIDTH COLUMNS */
        .col-id { width: 50px; text-align: center; }
        .col-date { width: 160px; }
        .col-mode { width: 220px; }
        .col-money { width: 150px; }
        .col-action { width: 60px; text-align: center; }

        /* FLUID COLUMNS (Will wrap text) */
        .col-desc { min-width: 350px; }
        .col-remarks { min-width: 300px; }

        td { 
            padding: 1.2rem 1rem; 
            border-bottom: 1px solid #f1f5f9; 
            vertical-align: top; 
            font-size: 0.95rem;
            line-height: 1.5;
            word-wrap: break-word; /* Allows long words to break */
            white-space: normal;  /* Essential for wrapping */
        }

        /* Editable Cells Enhancement */
        td[contenteditable="true"] {
            background: #fafbfc;
            border: 1px solid transparent;
            border-radius: 4px;
            padding: 10px;
            min-height: 45px;
            transition: 0.2s;
        }
        td[contenteditable="true"]:focus { 
            background: white; 
            border-color: var(--indigo); 
            outline: none; 
            box-shadow: 0 0 0 3px rgba(67, 56, 202, 0.1);
        }

        select, input[type="date"] {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--slate-200);
            border-radius: 4px;
            font-family: inherit;
        }

        /* --- BUTTONS --- */
        .btn {
            padding: 0.7rem 1.2rem; border-radius: 6px; font-weight: 700; font-size: 0.85rem;
            cursor: pointer; display: inline-flex; align-items: center; gap: 8px; border: none; transition: 0.2s;
        }
        .btn-primary { background: var(--navy); color: white; }
        .btn-primary:hover { background: #000; }
        .btn-outline { background: white; border: 1px solid var(--slate-200); color: var(--slate-700); }
        .btn-danger { color: #be123c; background: #fff1f2; width: 35px; height: 35px; justify-content: center; border-radius: 6px; cursor: pointer; border: none; }
        .btn-danger:hover { background: #ffe4e6; }

        @media print {
            .action-bar, .btn-danger, .btn { display: none !important; }
            .main-wrapper { box-shadow: none !important; border: none !important; padding: 0; }
            td[contenteditable="true"] { background: none; padding: 0; }
        }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div class="page-header">
        <h1 style="color:var(--navy); font-weight: 800; letter-spacing: -0.02em;">HSG PROJECT MONITORING</h1>
        <p style="color: #64748b; font-size: 0.9rem; margin-top: 5px;">Portfolio Tracking & Fiscal Management</p>
    </div>

    <div class="summary-grid">
        <div class="summary-card card-total">
            <h3>TOTAL PORTFOLIO ABC</h3>
            <div class="amount" id="totalABC">₱0.00</div>
        </div>
        <div class="summary-card card-svp">
            <h3>SVP TOTAL</h3>
            <div class="amount" id="svpABC">₱0.00</div>
        </div>
        <div class="summary-card card-shop">
            <h3>SHOPPING TOTAL</h3>
            <div class="amount" id="shoppingABC">₱0.00</div>
        </div>
        <div class="summary-card card-nego">
            <h3>NEGOTIATED TOTAL</h3>
            <div class="amount" id="negotiatedABC">₱0.00</div>
        </div>
    </div>

    <div class="action-bar">
        <input type="text" id="searchInput" class="search-bar" placeholder="Search by description or remarks...">
        <div style="display:flex; gap:10px;">
            <button id="addEmptyRowBtn" class="btn btn-outline"><i class="fas fa-plus"></i> Add Entry</button>
            <button id="updateRowBtn" class="btn btn-primary"><i class="fas fa-save"></i> Sync to Database</button>
            <button onclick="window.print()" class="btn btn-outline"><i class="fas fa-print"></i> Print</button>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th class="col-id">#</th>
                    <th class="col-date">Date Out</th>
                    <th class="col-desc">Item Description</th>
                    <th class="col-mode">Procurement Mode</th>
                    <th class="col-money">ABC</th>
                    <th class="col-money">Bid Amount</th>
                    <th class="col-remarks">Remarks</th>
                    <th class="col-action"></th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    const SUPABASE_URL = "https://jdzfxfriydakuqegtahq.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkemZ4ZnJpeWRha3VxZWd0YWhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwODU0MTEsImV4cCI6MjA3NjY2MTQxMX0.8uuX1PUSKOg03AuZeJJ5HxSUhM-gqapTclMn2A3tD4U";
    const supabaseHSG = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const tableBody = document.getElementById("tableBody");
    const searchInput = document.getElementById("searchInput");
    let masterData = [];

    function formatCurrency(num) {
        return new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' }).format(num || 0);
    }

    async function loadData() {
        const { data, error } = await supabaseHSG.from("hsg_project_monitoring").select("*").order("id", { ascending: true });
        if (error) return console.error(error);
        masterData = data;
        renderFiltered();
    }

    function renderFiltered() {
        const query = searchInput.value.toLowerCase();
        const filtered = masterData.filter(row => 
            (row.item_description || "").toLowerCase().includes(query) || 
            (row.remarks || "").toLowerCase().includes(query)
        );
        
        tableBody.innerHTML = "";
        let totals = { abc: 0, svp: 0, shop: 0, nego: 0 };

        filtered.forEach((row, i) => {
            const val = parseFloat(row.abc) || 0;
            totals.abc += val;
            if (row.mode_of_procurement === "Small Value Procurement") totals.svp += val;
            if (row.mode_of_procurement === "Shopping") totals.shop += val;
            if (row.mode_of_procurement === "Negotiated") totals.nego += val;

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td class="col-id">${i + 1}</td>
                <td class="col-date"><input type="date" value="${row.date_out || ""}"></td>
                <td class="col-desc" contenteditable="true">${row.item_description || ""}</td>
                <td class="col-mode">
                    <select>
                        <option value="">-- Mode --</option>
                        <option ${row.mode_of_procurement === "Small Value Procurement" ? "selected" : ""}>Small Value Procurement</option>
                        <option ${row.mode_of_procurement === "Shopping" ? "selected" : ""}>Shopping</option>
                        <option ${row.mode_of_procurement === "Negotiated" ? "selected" : ""}>Negotiated</option>
                    </select>
                </td>
                <td class="col-money" contenteditable="true" style="font-weight:700;">${row.abc || ""}</td>
                <td class="col-money" contenteditable="true" style="color:var(--indigo); font-weight:700;">${row.bid_amount || ""}</td>
                <td class="col-remarks" contenteditable="true">${row.remarks || ""}</td>
                <td class="col-action">
                    <button class="btn-danger delete-btn" data-id="${row.id}"><i class="fas fa-trash"></i></button>
                </td>
            `;
            tableBody.appendChild(tr);
        });

        document.getElementById("totalABC").textContent = formatCurrency(totals.abc);
        document.getElementById("svpABC").textContent = formatCurrency(totals.svp);
        document.getElementById("shoppingABC").textContent = formatCurrency(totals.shop);
        document.getElementById("negotiatedABC").textContent = formatCurrency(totals.nego);
    }

    searchInput.oninput = renderFiltered;

    document.getElementById("updateRowBtn").onclick = async () => {
        const rows = tableBody.querySelectorAll("tr");
        for (let row of rows) {
            const id = row.querySelector(".delete-btn").dataset.id;
            const cells = row.querySelectorAll("td");
            const payload = {
                date_out: cells[1].querySelector("input").value,
                item_description: cells[2].innerText.trim(),
                mode_of_procurement: cells[3].querySelector("select").value,
                abc: cells[4].innerText.trim(),
                bid_amount: cells[5].innerText.trim(),
                remarks: cells[6].innerText.trim()
            };
            if (id) await supabaseHSG.from("hsg_project_monitoring").update(payload).eq("id", id);
            else if (payload.item_description) await supabaseHSG.from("hsg_project_monitoring").insert([payload]);
        }
        alert("Portfolio updated successfully.");
        loadData();
    };

    document.getElementById("addEmptyRowBtn").onclick = () => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td class="col-id">*</td>
            <td class="col-date"><input type="date"></td>
            <td class="col-desc" contenteditable="true"></td>
            <td class="col-mode"><select><option value="">-- Mode --</option><option>Small Value Procurement</option><option>Shopping</option><option>Negotiated</option></select></td>
            <td class="col-money" contenteditable="true"></td>
            <td class="col-money" contenteditable="true"></td>
            <td class="col-remarks" contenteditable="true"></td>
            <td class="col-action"><button class="btn-danger delete-btn"><i class="fas fa-trash"></i></button></td>
        `;
        tableBody.prepend(tr);
    };

    tableBody.onclick = async (e) => {
        if (e.target.closest(".delete-btn")) {
            const btn = e.target.closest(".delete-btn");
            if (btn.dataset.id && confirm("Delete record permanently?")) {
                await supabaseHSG.from("hsg_project_monitoring").delete().eq("id", btn.dataset.id);
                loadData();
            } else if (!btn.dataset.id) btn.closest("tr").remove();
        }
    };

    loadData();
</script>
</body>
</html>
