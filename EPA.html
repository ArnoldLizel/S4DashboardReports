<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EPA Procurement Table</title>
<script src="https://unpkg.com/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
<style>
    body {
        background-image: url('image/bg2.jpg');
        background-size: cover;
        background-position: center;
        background-attachment: fixed; /* Keeps background still while scrolling */
        background-repeat: no-repeat;
        min-height: 100vh;
    }

    /* Optional: If the background makes text hard to read, 
       this adds a subtle white overlay to the container */
    .container {
        background-color: rgba(255, 255, 255, 0.9); 
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
    }
</style>
<style>
/* ========================================
   Philippine Navy Dashboard - Unified Styles
   ======================================== */

/* ============= BASE STYLES ============= */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background-color: #f3f4f6;
  color: #1f2937;
  line-height: 1.6;
}

.container {
  max-width: 98%;
  margin: 0 auto;
  padding: 1.5rem;
}

/* ============= TYPOGRAPHY ============= */
h1, h2, h3, h4, h5, h6 {
  color: #0b1a3a;
  font-weight: 600;
  margin-bottom: 1rem;
}

h1 { font-size: 2rem; }

/* ============= CARDS ============= */
.card {
  background: white;
  border-radius: 0.5rem;
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
  padding: 1.5rem;
  margin-bottom: 1.5rem;
  border: 1px solid #e5e7eb;
  transition: box-shadow 0.3s ease;
}

.card:hover {
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.card-header {
  background: linear-gradient(135deg, #0b1a3a 0%, #1e3a8a 100%);
  color: white;
  padding: 1rem 1.5rem;
  border-radius: 0.5rem 0.5rem 0 0;
  margin: -1.5rem -1.5rem 1.5rem -1.5rem;
  font-weight: 600;
  font-size: 1.125rem;
  border-left: 4px solid #f1c232;
}

/* ============= BUTTONS ============= */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.625rem 1.25rem;
  font-size: 0.875rem;
  font-weight: 500;
  border-radius: 0.375rem;
  border: none;
  cursor: pointer;
  transition: all 0.2s ease;
  text-decoration: none;
  text-align: center;
  white-space: nowrap;
  margin-right: 0.5rem;
  margin-bottom: 0.5rem;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn-primary {
  background-color: #0b1a3a;
  color: white;
}

.btn-primary:hover:not(:disabled) {
  background-color: #1e3a8a;
  box-shadow: 0 4px 6px -1px rgba(11, 26, 58, 0.3);
}

.btn-success {
  background-color: #10b981;
  color: white;
}

.btn-success:hover:not(:disabled) {
  background-color: #059669;
}

.btn-danger {
  background-color: #ef4444;
  color: white;
}

.btn-danger:hover:not(:disabled) {
  background-color: #dc2626;
}

.btn-sm {
  padding: 0.375rem 0.875rem;
  font-size: 0.8125rem;
}

/* ============= TABLES ============= */
.table-responsive {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  margin-bottom: 1.5rem;
}

.table {
  width: 100%;
  border-collapse: collapse;
  background-color: white;
  font-size: 0.875rem;
}

.table thead {
  background: linear-gradient(135deg, #0b1a3a 0%, #1e3a8a 100%);
  color: white;
}

.table thead th {
  padding: 0.875rem 1rem;
  text-align: center;
  font-weight: 600;
  font-size: 0.8125rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  border-bottom: 2px solid #f1c232;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.table tbody tr {
  border-bottom: 1px solid #e5e7eb;
  transition: background-color 0.15s ease;
}

.table tbody tr:hover {
  background-color: #f9fafb;
}

.table tbody td {
  padding: 0.875rem 1rem;
  color: #4b5563;
  vertical-align: middle;
  text-align: center;
  border: 1px solid #e5e7eb;
}

/* Sub-header row styling */
.sub-header-row td {
  background: linear-gradient(135deg, #475569 0%, #64748b 100%);
  color: white;
  font-weight: 600;
  text-align: left;
  padding-left: 1rem;
  border: 1px solid rgba(255, 255, 255, 0.1);
  white-space: nowrap;
}

/* Column widths */
.table th:nth-child(1), .table td:nth-child(1) { width: 60px; }
.table th:nth-child(2), .table td:nth-child(2) { width: 22%; }
.table th:nth-child(3), .table td:nth-child(3) { width: 8%; }
.table th:nth-child(4), .table td:nth-child(4),
.table th:nth-child(5), .table td:nth-child(5),
.table th:nth-child(6), .table td:nth-child(6),
.table th:nth-child(7), .table td:nth-child(7),
.table th:nth-child(8), .table td:nth-child(8),
.table th:nth-child(9), .table td:nth-child(9) { width: 7%; }
.table th:nth-child(10), .table td:nth-child(10) { width: 30%; min-width: 280px; }
.table th:nth-child(11), .table td:nth-child(11) { 
  width: 70px !important; 
  max-width: 70px !important;
  white-space: nowrap; 
  text-align: center; 
  padding: 0.4rem 0.2rem !important; 
}

/* ============= FORMS ============= */
.form-control {
  display: block;
  width: 100%;
  padding: 0.625rem 0.875rem;
  font-size: 0.875rem;
  font-weight: 400;
  line-height: 1.5;
  color: #1f2937;
  background-color: white;
  border: 1px solid #d1d5db;
  border-radius: 0.375rem;
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.form-control:focus {
  color: #1f2937;
  background-color: white;
  border-color: #2563eb;
  outline: 0;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

textarea.form-control {
  resize: none;
  text-align: left;
  overflow: hidden;
  min-height: 38px;
}

input[type="number"].form-control {
  text-align: center;
}

input[type="date"].form-control {
  text-align: center;
  padding: 0.5rem 0.625rem;
}

/* Specific textarea styling */
td:nth-child(2) textarea {
  width: 100%;
  padding: 6px;
}

td:nth-child(10) textarea {
  width: 100%;
  padding: 6px;
}

/* Delete button styling */
.delete-btn {
  background-color: #ef4444;
  color: white;
  border: none;
  padding: 0.35rem 0.5rem;
  border-radius: 0.25rem;
  cursor: pointer;
  font-size: 0.7rem;
  font-weight: 500;
  transition: background-color 0.2s;
  white-space: nowrap;
  display: inline-block;
}

.delete-btn:hover {
  background-color: #dc2626;
}

/* ============= UTILITIES ============= */
.text-center { text-align: center; }
.mb-2 { margin-bottom: 1rem; }

/* ============= RESPONSIVE DESIGN ============= */
@media (max-width: 768px) {
  .container {
    padding: 1rem;
  }
  
  .card {
    padding: 1rem;
  }
  
  .card-header {
    margin: -1rem -1rem 1rem -1rem;
    padding: 0.75rem 1rem;
    font-size: 1rem;
  }
  
  .table {
    font-size: 0.8125rem;
  }
  
  .table thead th,
  .table tbody td {
    padding: 0.5rem;
  }
  
  .btn {
    padding: 0.5rem 1rem;
    font-size: 0.8125rem;
  }
}
</style>
</head>

<body>
<div class="container">
  <div class="card">
    <div class="card-header">
      EPA Procurement Table
    </div>

    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Item Nr</th>
            <th>Title</th>
            <th>ABC</th>
            <th>Pre-Proc</th>
            <th>Pre-Bid</th>
            <th>SOBE</th>
            <th>PQ</th>
            <th>NOA</th>
            <th>NTP</th>
            <th>Remarks</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <div>
      <button class="btn btn-success" id="addBtn">+ Add Item</button>
      <button class="btn btn-primary" id="saveBtn">üíæ Save</button>
      <button class="btn btn-danger" id="clearBtn">üóëÔ∏è Clear All</button>
    </div>

  </div>
</div>

<script>
(() => {
  /* =========================
     Supabase config (from user)
     ========================= */

  const SUPABASE_URL = "https://jdzfxfriydakuqegtahq.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkemZ4ZnJpeWRha3VxZWd0YWhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwODU0MTEsImV4cCI6MjA3NjY2MTQxMX0.8uuX1PUSKOg03AuZeJJ5HxSUhM-gqapTclMn2A3tD4U";

  const TABLE = "epa_procurement"; // matches your SQL

  let supabase = null;

  /* =========================
     Base UI items (headers + placeholders)
     Keep this unchanged ‚Äî headers are static and NOT saved to DB
     ========================= */
  const baseTemplate = [
    { text:"Goods and Services", colspan:true },
  ];

  // Working items array (rendered)
  let items = JSON.parse(JSON.stringify(baseTemplate));

  const tbody = document.getElementById("tableBody");
  let currentYear = new Date().getFullYear().toString(); // Set default year immediately

  /* =========================================
     Utilities
     ========================================= */
  const autoResize = (el) => {
    el.style.height = "auto";
    el.style.height = el.scrollHeight + "px";
  };
  window.autoResize = autoResize;

  function escapeHtml(str) {
    if (str === undefined || str === null) return "";
    return String(str).replace(/[&<>"']/g, function(m){
      return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m];
    });
  }

  /* Convert DB row -> UI item (data rows only) */
  function dbRowToUiItem(row) {
    return {
      id: row.id,
      title: row.title || "",
      abc: row.abc !== null ? String(row.abc) : "",
      preProc: row.pre_proc || "",
      preBid: row.pre_bid || "",
      sobe: row.sobe || "",
      pq: row.pq || "",
      noa: row.noa || "",
      ntp: row.ntp || "",
      remarks: row.remarks || ""
    };
  }

  /* =========================================
     Render table from items[]
     ========================================= */
  const renderTable = () => {
    tbody.innerHTML = "";

    items.forEach((item, idx) => {
      const row = document.createElement("tr");

      if (item.colspan) {
        row.classList.add("sub-header-row");
        row.innerHTML = `<td colspan="11">${escapeHtml(item.text)}</td>`;
      } else {
        row.innerHTML = `
          <td>${idx}</td>

          <td>
            <textarea class="form-control" data-field="title" data-index="${idx}" oninput="autoResize(this)">${escapeHtml(item.title || "")}</textarea>
          </td>

          <td><input type="number" class="form-control" data-field="abc" data-index="${idx}" value="${escapeHtml(item.abc || "")}"></td>

          <td><input type="date" class="form-control" data-field="preProc" data-index="${idx}" value="${escapeHtml(item.preProc || "")}"></td>
          <td><input type="date" class="form-control" data-field="preBid" data-index="${idx}" value="${escapeHtml(item.preBid || "")}"></td>
          <td><input type="date" class="form-control" data-field="sobe" data-index="${idx}" value="${escapeHtml(item.sobe || "")}"></td>
          <td><input type="date" class="form-control" data-field="pq" data-index="${idx}" value="${escapeHtml(item.pq || "")}"></td>
          <td><input type="date" class="form-control" data-field="noa" data-index="${idx}" value="${escapeHtml(item.noa || "")}"></td>
          <td><input type="date" class="form-control" data-field="ntp" data-index="${idx}" value="${escapeHtml(item.ntp || "")}"></td>

          <td>
            <textarea class="form-control" data-field="remarks" data-index="${idx}" oninput="autoResize(this)">${escapeHtml(item.remarks || "")}</textarea>
          </td>

          <td>
            <button class="delete-btn" data-index="${idx}">Delete</button>
          </td>
        `;
      }

      tbody.appendChild(row);
    });

    // wire up delete buttons and change listeners
    tbody.querySelectorAll(".delete-btn").forEach(btn => {
      btn.addEventListener("click", (e) => {
        const idx = Number(btn.getAttribute("data-index"));
        handleDelete(idx);
      });
    });

    tbody.querySelectorAll("[data-field]").forEach(el => {
      el.addEventListener("input", (e) => {
        const idx = Number(el.getAttribute("data-index"));
        const field = el.getAttribute("data-field");
        const val = el.value;
        if (!items[idx] || items[idx].colspan) return;
        if (field === "title" || field === "remarks") items[idx][field] = val;
        else if (field === "abc") items[idx].abc = val;
        else if (field === "preProc") items[idx].preProc = val;
        else if (field === "preBid") items[idx].preBid = val;
        else if (field === "sobe") items[idx].sobe = val;
        else if (field === "pq") items[idx].pq = val;
        else if (field === "noa") items[idx].noa = val;
        else if (field === "ntp") items[idx].ntp = val;
      });
    });

    // Trigger auto-resize after rendering
    document.querySelectorAll("textarea").forEach(autoResize);
  };

  /* =========================================
     CRUD: load only data rows (is_header = false)
     Merge DB data into baseTemplate (headers remain static)
     ========================================= */
  async function loadFromDb() {
    if (!supabase) {
      console.warn("Supabase not initialized, skipping load");
      renderTable();
      return;
    }
    if (!currentYear) {
      console.warn("No year set, skipping load");
      renderTable();
      return;
    }

    console.log("Loading data from database for year:", currentYear);

    try {
      const { data, error } = await supabase
        .from(TABLE)
        .select("*")
        .eq("year", Number(currentYear))
        .eq("is_header", false)
        .order("item_number", { ascending: true });

      if (error) throw error;

      console.log("Data loaded from DB:", data);

      // DB data rows mapped to UI items
      const dataRows = (data || []).map(dbRowToUiItem);
      
      console.log("Mapped data rows:", dataRows);

      // Rebuild items from baseTemplate: keep headers, fill non-header slots from dataRows
      const newItems = [];
      let di = 0;
      for (let i = 0; i < baseTemplate.length; i++) {
        const tpl = baseTemplate[i];
        if (tpl.colspan) {
          newItems.push(JSON.parse(JSON.stringify(tpl)));
        } else {
          if (di < dataRows.length) {
            newItems.push(dataRows[di]);
            di++;
          } else {
            // empty placeholder row
            newItems.push({ title: "", abc: "", preProc: "", preBid: "", sobe: "", pq: "", noa: "", ntp: "", remarks: "" });
          }
        }
      }

      // If DB has more data rows than UI slots, append them after template (no headers)
      while (di < dataRows.length) {
        newItems.push(dataRows[di]);
        di++;
      }

      items = newItems;
      console.log("Items array updated, rendering table...");
      renderTable();

    } catch (err) {
      console.error("Error loading data:", err);
      alert("Failed to load data from Supabase. Error: " + err.message);
      // Render empty template on error
      items = JSON.parse(JSON.stringify(baseTemplate));
      renderTable();
    }
  }

  /* =========================================
     saveToDb: upsert only non-header rows
     item_number is 0-based index among data rows (ignoring headers)
     ========================================= */
  async function saveToDb() {
    console.log("=== SAVE FUNCTION CALLED ===");
    
    if (!supabase) {
      console.error("Supabase not initialized!");
      alert("Database connection not ready. Please wait a moment and try again.");
      return;
    }
    
    if (!currentYear) {
      console.error("No year selected!");
      alert("No year selected. Please select a year first.");
      return;
    }

    console.log("Supabase check passed, year:", currentYear);

    // Separate rows into updates (with id) and inserts (without id)
    const rowsToUpdate = [];
    const rowsToInsert = [];
    let dataIndex = 0;
    
    for (let i = 0; i < items.length; i++) {
      const it = items[i];
      if (it.colspan) continue; // do NOT save headers
      
      // map UI -> DB (without id for inserts)
      const rowData = {
        item_number: dataIndex,
        title: it.title || null,
        abc: (it.abc !== undefined && it.abc !== "") ? Number(it.abc) : null,
        pre_proc: it.preProc || null,
        pre_bid: it.preBid || null,
        sobe: it.sobe || null,
        pq: it.pq || null,
        noa: it.noa || null,
        ntp: it.ntp || null,
        remarks: it.remarks || null,
        is_header: false,
        header_text: null,
        year: Number(currentYear) || (new Date()).getFullYear()
      };
      
      // Check if this is an existing row (has valid id)
      if (it.id && typeof it.id === 'number' && it.id > 0) {
        // Existing row - include id for update
        console.log("Row", dataIndex, "- Updating existing with id:", it.id);
        rowsToUpdate.push({ id: it.id, ...rowData });
      } else {
        // New row - don't include id
        console.log("Row", dataIndex, "- Inserting new row");
        rowsToInsert.push(rowData);
      }
      
      dataIndex++;
    }

    console.log("Rows to update:", rowsToUpdate.length, rowsToUpdate);
    console.log("Rows to insert:", rowsToInsert.length, rowsToInsert);

    try {
      // Update existing rows ONE BY ONE
      if (rowsToUpdate.length > 0) {
        console.log("Updating", rowsToUpdate.length, "existing rows...");
        
        for (const row of rowsToUpdate) {
          const rowId = row.id;
          const { id, ...updateData } = row; // Remove id from update data
          
          console.log("Updating row id:", rowId, "with data:", updateData);
          
          const { data: updatedData, error: updateError } = await supabase
            .from(TABLE)
            .update(updateData)
            .eq('id', rowId)
            .select();
          
          if (updateError) {
            console.error("Update error for row", rowId, ":", updateError);
            throw updateError;
          }
          console.log("‚úÖ Updated row", rowId, ":", updatedData);
        }
        console.log("All updates completed!");
      }
      
      // Insert new rows
      if (rowsToInsert.length > 0) {
        console.log("Inserting", rowsToInsert.length, "new rows...");
        const { data: insertedData, error: insertError } = await supabase
          .from(TABLE)
          .insert(rowsToInsert)
          .select();
        
        if (insertError) {
          console.error("Insert error:", insertError);
          throw insertError;
        }
        console.log("‚úÖ Inserted successfully:", insertedData);
      }

      console.log("Save successful!");

      // Re-load from DB to ensure ids and ordering are accurate
      await loadFromDb();
      alert("Saved successfully for year " + currentYear + "!");
    } catch (err) {
      console.error("Save error:", err);
      alert("Failed to save data. Error: " + err.message + ". Check console for details.");
    }
  }

  /* =========================================
     Delete a single row (non-header)
     - If row has id, delete from DB
     - Remove from items[]
     - Reload from DB to get fresh data
     ========================================= */
  async function handleDelete(idx) {
    if (!items[idx]) return;
    
    // Check if it's a header row - if so, just silently ignore (no alert)
    if (items[idx].colspan) {
      return;
    }
    
    if (!confirm("Are you sure you want to delete this item?")) return;

    const item = items[idx];

    // If it had an id, delete from DB
    if (item.id && supabase) {
      try {
        console.log("Deleting row with id:", item.id);
        const { error } = await supabase.from(TABLE).delete().eq("id", item.id);
        if (error) throw error;
        console.log("Row deleted successfully");
        
        // Reload from database to get fresh data with correct item_numbers
        await loadFromDb();
        alert("Item deleted successfully!");
      } catch (err) {
        console.error("Delete error:", err);
        alert("Failed to delete row from database. Error: " + err.message);
        return;
      }
    } else {
      // Row doesn't have an ID yet (not saved to DB), just remove from UI
      items.splice(idx, 1);
      renderTable();
    }
  }
  window.deleteRow = handleDelete;

  /* =========================================
     Clear all data rows for the selected year
     (does NOT touch headers)
     ========================================= */
  async function clearAllForYear() {
    if (!confirm("Are you sure you want to clear all data for year " + currentYear + "?")) return;
    if (!supabase) return;

    try {
      const { error } = await supabase.from(TABLE).delete().eq("year", Number(currentYear)).eq("is_header", false);
      if (error) throw error;

      // reset items to base template with empty data rows
      const reset = [];
      for (let i = 0; i < baseTemplate.length; i++) {
        const t = baseTemplate[i];
        if (t.colspan) reset.push(JSON.parse(JSON.stringify(t)));
        else reset.push({ title: "", abc: "", preProc: "", preBid: "", sobe: "", pq: "", noa: "", ntp: "", remarks: "" });
      }
      items = reset;
      renderTable();
      alert("All data cleared for year " + currentYear + ".");
    } catch (err) {
      console.error("Clear error:", err);
      alert("Failed to clear data. See console.");
    }
  }

  /* =========================================
     UI Buttons wiring
     ========================================= */
  document.getElementById("addBtn").addEventListener("click", () => {
    // Insert a new data row just before the last template element, preserving headers
    // Find last non-header index from end to insert before the last header if needed
    // For simplicity, insert before the last element of items array
    const insertIndex = items.length - 1; // safe default
    items.splice(insertIndex, 0, { title: "", abc: "", preProc: "", preBid: "", sobe: "", pq: "", noa: "", ntp: "", remarks: "" });
    renderTable();
  });

  document.getElementById("saveBtn").addEventListener("click", async () => {
    console.log("Save button clicked!");
    console.log("Current year:", currentYear);
    console.log("Supabase initialized:", !!supabase);
    console.log("Items to save:", items);
    await saveToDb();
  });

  document.getElementById("clearBtn").addEventListener("click", async () => {
    await clearAllForYear();
  });

  /* =========================================
     Listen for year changes from parent (same as before)
     When year arrives, initialize supabase (if needed) and load data
     ========================================= */
  window.addEventListener("message", async (event) => {
    if (event.data.year) {
      currentYear = event.data.year;
      try {
        await ensureSupabase();
        await loadFromDb();
      } catch (err) {
        console.error("Init/load error:", err);
        alert("Failed to initialize Supabase or load data. See console.");
      }
    }
  });

  /* Initialize on page load in case year already set programmatically */
  async function ensureSupabase() {
    if (supabase) {
      console.log("Supabase already initialized");
      return;
    }
    
    try {
      console.log("Checking if Supabase library is available...");
      
      // Wait a bit for the script to load if needed
      let attempts = 0;
      while (!window.supabase && attempts < 20) {
        console.log("Waiting for Supabase library... attempt", attempts + 1);
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
      }
      
      if (!window.supabase) {
        throw new Error("Supabase library not found after waiting");
      }
      
      console.log("Supabase library found! Creating client...");
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      console.log("‚úÖ Supabase client created successfully!");
    } catch (err) {
      console.error("‚ùå Failed to initialize Supabase:", err);
      alert("‚ö†Ô∏è Failed to load database connection.\n\nError: " + err.message + "\n\nPlease:\n1. Check your internet connection\n2. Disable tracking prevention\n3. Refresh the page");
      throw err;
    }
  }

  (async () => {
    try {
      await ensureSupabase();
      // Always load data for current year on initialization
      console.log("Initializing with year:", currentYear);
      await loadFromDb();
    } catch (err) {
      console.warn("Initialization error:", err);
      // If loading fails, at least render the empty template
      renderTable();
    }
  })();

})();
</script>


</body>
</html>