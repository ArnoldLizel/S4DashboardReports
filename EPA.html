<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPA Procurement | Auto-Expand View</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --brand-navy: #0b2b74;
            --brand-gold: #570488;
            --slate-50: #f8fafc;
            --slate-200: #e2e8f0;
            --slate-700: #334155;
            --glass: rgba(255, 255, 255, 0.97);
            --fs-base: 1rem;
            --fs-table: 0.95rem;
            --fs-header: 0.85rem;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-image: url('image/bg2.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
            padding: 2rem;
            color: var(--slate-700);
            font-size: var(--fs-base);
        }

        .main-container {
            max-width: 98%;
            margin: 0 auto;
            background: var(--glass);
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            padding: 2.5rem;
            backdrop-filter: blur(10px);
            border: 1px solid white;
        }

        .header-flex {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        h1 { 
            color: var(--brand-navy); 
            font-weight: 800; 
            text-transform: uppercase; 
            font-size: 1.8rem;
            letter-spacing: -0.02em;
        }

        .table-responsive {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--slate-200);
            background: white;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table thead th {
            background-color: var(--brand-navy);
            color: white;
            padding: 1.2rem 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            font-size: var(--fs-header);
            border: 1px solid #062250;
            text-align: center;
        }

        .sub-header-row td {
            background: #f1f5f9 !important;
            color: var(--brand-navy);
            font-weight: 800;
            font-size: 1.1rem;
            padding: 15px 1.5rem;
            border-left: 6px solid var(--brand-gold);
        }

        .table tbody td {
            padding: 0.75rem;
            border: 1px solid var(--slate-200);
            vertical-align: top;
            font-size: var(--fs-table);
        }

        .col-nr { width: 60px; text-align: center; font-weight: 800; color: var(--brand-gold); }
        .col-title { width: 350px; }
        .col-abc { width: 160px; }
        .col-date { width: 165px; }
        .col-remarks { min-width: 500px; }
        .col-action { width: 80px; text-align: center; }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid transparent;
            border-radius: 6px;
            background: #f1f5f9;
            font-family: inherit;
            font-size: var(--fs-table);
            transition: 0.2s;
            line-height: 1.4;
            overflow: hidden; /* Hide scrollbars during auto-expand */
        }

        .form-control:focus {
            background: white;
            border-color: var(--brand-gold);
            outline: none;
            box-shadow: 0 0 0 4px rgba(87, 4, 136, 0.1);
        }

        textarea.form-control { 
            min-height: 45px; 
            resize: none; /* Prevents manual resizing which breaks auto-layout */
            display: block;
        }

        .btn-group { display: flex; gap: 15px; margin-top: 2rem; }
        .btn {
            padding: 14px 28px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: 0.3s;
        }
        .btn-success { background: #0a32e7; color: white; }
        .btn-primary { background: var(--brand-navy); color: white; }
        .btn-danger { background: #016aa7; color: #e6e0e0; border: 1px solid #064a75; }
        
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }

        .delete-btn { 
            color: #fd4747; 
            background: #fff1f2; 
            border: 1px solid #ffe4e6; 
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer; 
        }
    </style>
</head>
<body>

<div class="main-container">
    <div class="header-flex">
        <h1>EPA Procurement Dashboard</h1>
        <div id="yearBox" style="background: var(--brand-gold); color: white; padding: 10px 20px; border-radius: 8px; font-weight: 800; font-size: 1.1rem;">
            FY <span id="currentYearDisplay">----</span>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th class="col-nr">Nr</th>
                    <th class="col-title">Item Title / Project Name</th>
                    <th class="col-abc">ABC (â‚±)</th>
                    <th class="col-date">Pre-Proc</th>
                    <th class="col-date">Pre-Bid</th>
                    <th class="col-date">SOBE</th>
                    <th class="col-date">PQ</th>
                    <th class="col-date">NOA</th>
                    <th class="col-date">NTP</th>
                    <th class="col-remarks">Remarks & Detailed Status</th>
                    <th class="col-action">Action</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div class="btn-group">
        <button class="btn btn-success" id="addBtn"><i class="fas fa-plus-circle"></i> Add New Item</button>
        <button class="btn btn-primary" id="saveBtn"><i class="fas fa-cloud-upload-alt"></i> Save All Changes</button>
        <button class="btn btn-danger" id="clearBtn"><i class="fas fa-redo"></i> Reset Year</button>
    </div>
</div>

<script>
(() => {
    const SUPABASE_URL = "https://jdzfxfriydakuqegtahq.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkemZ4ZnJpeWRha3VxZWd0YWhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwODU0MTEsImV4cCI6MjA3NjY2MTQxMX0.8uuX1PUSKOg03AuZeJJ5HxSUhM-gqapTclMn2A3tD4U";
    const TABLE = "epa_procurement";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let items = [{ text: "Goods and Services", colspan: true }];
    let currentYear = new Date().getFullYear().toString();

    // --- HELPER: AUTO EXPAND ---
    const autoExpand = (el) => {
        el.style.height = 'auto';
        el.style.height = el.scrollHeight + 'px';
    };

    const render = () => {
        const tbody = document.getElementById("tableBody");
        document.getElementById("currentYearDisplay").innerText = currentYear;
        tbody.innerHTML = "";

        items.forEach((item, idx) => {
            const tr = document.createElement("tr");
            if (item.colspan) {
                tr.className = "sub-header-row";
                tr.innerHTML = `<td colspan="11"><i class="fas fa-folder-open"></i> &nbsp; ${item.text}</td>`;
            } else {
                tr.innerHTML = `
                    <td class="col-nr">${idx}</td>
                    <td><textarea class="form-control" data-field="title" data-idx="${idx}">${item.title || ""}</textarea></td>
                    <td><input type="number" class="form-control" style="font-weight:700" data-field="abc" data-idx="${idx}" value="${item.abc || ""}"></td>
                    <td><input type="date" class="form-control" data-field="preProc" data-idx="${idx}" value="${item.preProc || ""}"></td>
                    <td><input type="date" class="form-control" data-field="preBid" data-idx="${idx}" value="${item.preBid || ""}"></td>
                    <td><input type="date" class="form-control" data-field="sobe" data-idx="${idx}" value="${item.sobe || ""}"></td>
                    <td><input type="date" class="form-control" data-field="pq" data-idx="${idx}" value="${item.pq || ""}"></td>
                    <td><input type="date" class="form-control" data-field="noa" data-idx="${idx}" value="${item.noa || ""}"></td>
                    <td><input type="date" class="form-control" data-field="ntp" data-idx="${idx}" value="${item.ntp || ""}"></td>
                    <td><textarea class="form-control" data-field="remarks" data-idx="${idx}">${item.remarks || ""}</textarea></td>
                    <td class="col-action"><button class="delete-btn" data-del-idx="${idx}"><i class="fas fa-trash-alt"></i></button></td>
                `;
            }
            tbody.appendChild(tr);
        });

        // Trigger expand for all textareas after render
        document.querySelectorAll('textarea.form-control').forEach(autoExpand);
    };

    // --- EVENT DELEGATION FOR INPUTS ---
    document.getElementById("tableBody").addEventListener("input", (e) => {
        const { field, idx } = e.target.dataset;
        if (field && idx) items[idx][field] = e.target.value;
        
        // Auto-expand if it's a textarea
        if (e.target.tagName === 'TEXTAREA') {
            autoExpand(e.target);
        }
    });

    // --- EVENT DELEGATION FOR DELETE ---
    document.getElementById("tableBody").addEventListener("click", async (e) => {
        const delBtn = e.target.closest('.delete-btn');
        if (delBtn) {
            const idx = delBtn.dataset.delIdx;
            if (!confirm("Delete this entry?")) return;
            
            const item = items[idx];
            if (item.id) {
                const { error } = await supabase.from(TABLE).delete().eq("id", item.id);
                if (error) { alert("Error deleting: " + error.message); return; }
            }
            items.splice(idx, 1);
            render();
        }
    });

    async function loadData() {
        const { data } = await supabase.from(TABLE).select("*").eq("year", currentYear).order("item_number");
        if (data && data.length > 0) {
            items = [{ text: "Goods and Services", colspan: true }, ...data.map(d => ({
                id: d.id, title: d.title, abc: d.abc, preProc: d.pre_proc, 
                preBid: d.pre_bid, sobe: d.sobe, pq: d.pq, noa: d.noa, ntp: d.ntp, remarks: d.remarks
            }))];
        } else {
            items = [{ text: "Goods and Services", colspan: true }];
        }
        render();
    }

    document.getElementById("saveBtn").onclick = async () => {
        const rows = items.filter(i => !i.colspan).map((it, i) => ({
            item_number: i, title: it.title, abc: it.abc ? parseFloat(it.abc) : null,
            pre_proc: it.preProc, pre_bid: it.preBid, sobe: it.sobe, pq: it.pq, 
            noa: it.noa, ntp: it.ntp, remarks: it.remarks, year: parseInt(currentYear), is_header: false
        }));
        const { error } = await supabase.from(TABLE).upsert(rows, { onConflict: 'item_number, year' });
        if (error) alert("Error: " + error.message);
        else alert("Data synchronized for year " + currentYear);
        loadData();
    };

    document.getElementById("addBtn").onclick = () => {
        items.push({ title: "", abc: "", preProc: "", preBid: "", sobe: "", pq: "", noa: "", ntp: "", remarks: "" });
        render();
    };

    loadData();
})();
</script>
</body>
</html>
