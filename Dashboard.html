<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PN Logistics | Command Dashboard</title>
  
  <link rel="icon" type="image/png" sizes="32x32" href="image/hsg1.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    
    .active-tab { 
      background-color: #2563eb !important; 
      border-left: 4px solid #60a5fa !important;
      color: white !important;
    }
    
    .menu-btn { transition: all 0.2s ease; border-left: 4px solid transparent; color: #cbd5e1; cursor: pointer; }
    .menu-btn:hover { background-color: #334155; color: white; }

    .main-content-bg {
      position: relative;
      background-image: url('image/bg2.jpg');
      background-size: cover; background-position: center; background-attachment: fixed;
    }

    #iframe-view {
      position: fixed;
      top: 64px; left: 0; right: 0; bottom: 0;
      z-index: 100; background: white;
    }
    @media (min-width: 768px) { #iframe-view { left: 16rem; } }
    #iframe-view iframe { width: 100%; height: 100%; border: none; }

    :root {
        --navy-blue: #0b1a3a;
        --neon-blue: #00d4ff;
        --pulse-gold: #f1c232;
    }

    #branch-compliance-widget {
        position: fixed; right: 30px; top: 55%;
        transform: translateY(-50%);
        display: flex; flex-direction: column; gap: 15px; z-index: 30;
    }

 /* ZOOM CONFERENCE WIDGET POSITIONING */
    #zoom-widget {
        position: fixed;
        left: 17rem; /* Adjusted to sit next to the 64px (16rem) sidebar */
        bottom: 20px;
        width: 320px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        z-index: 30;
        display: block;
        transition: opacity 0.3s;
    }

    @media (max-width: 768px) {
        #zoom-widget { left: 20px; width: calc(100% - 40px); }
    }

    .zoom-header {
        background: linear-gradient(135deg, #2D8CFF 0%, #0B5CFF 100%);
        color: white;
        padding: 0.75rem 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    .zoom-icon {
        width: 32px;
        height: 32px;
        background: white;
        border-radius: 8px;
        padding: 4px;
    }

    .zoom-body {
        max-height: 300px;
        overflow-y: auto;
    }

    .zoom-body::-webkit-scrollbar { width: 4px; }
    .zoom-body::-webkit-scrollbar-track { background: transparent; }
    .zoom-body::-webkit-scrollbar-thumb { background-color: #e5e7eb; border-radius: 20px; }

    .conference-item {
        padding: 1rem;
        border-bottom: 1px solid #f3f4f6;
        transition: background 0.2s;
    }

    .conference-item:hover {
        background: #f9fafb;
    }

    .conference-item:last-child {
        border-bottom: none;
    }

    .conference-title {
        font-weight: 600;
        color: #1f2937;
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
    }

    .conference-date {
        font-size: 0.75rem;
        color: #6b7280;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        margin-bottom: 0.25rem;
    }

    .conference-location {
        font-size: 0.75rem;
        color: #6b7280;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .no-conferences {
        padding: 2rem;
        text-align: center;
        color: #9ca3af;
        font-size: 0.875rem;
    }

    .widget-hidden { opacity: 0; visibility: hidden; pointer-events: none; }
    .branch-row { display: flex; align-items: center; justify-content: flex-end; position: relative; }

    .pulse-gold { border: 5px solid var(--pulse-gold) !important; animation: goldGlow 2s infinite; }
    @keyframes goldGlow {
        0%, 100% { box-shadow: 0 0 15px var(--pulse-gold); }
        50% { box-shadow: 0 0 35px var(--pulse-gold); }
    }

    .portrait-box {
        width: 130px; height: 160px;
        background: #000; border: 4px solid #1e293b; border-radius: 10px;
        overflow: hidden; transition: 0.3s; cursor: pointer;
    }
    .portrait-box:hover { transform: scale(1.05); border-color: var(--neon-blue); }
    .portrait-box img { width: 100%; height: 100%; object-fit: cover; }

    .mini-screen {
        display: none; position: absolute; 
        right: 150px; 
        top: 50%; transform: translateY(-50%);
        width: 450px; background: white; border: 3px solid var(--neon-blue);
        border-radius: 12px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); z-index: 200;
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from { opacity: 0; transform: translateY(-50%) translateX(20px); }
        to { opacity: 1; transform: translateY(-50%) translateX(0); }
    }

    .branch-row:hover .mini-screen { display: block; }
    .mini-header { background: var(--navy-blue); color: white; padding: 12px; font-weight: bold; font-size: 0.9rem; border-top-left-radius: 8px; border-top-right-radius: 8px; }
    .mini-body { padding: 10px; max-height: 300px; overflow-y: auto; }

    .comp-table { width: 100%; font-size: 0.85rem; border-collapse: collapse; }
    .comp-table th { text-align: left; padding: 8px; background: #f1f5f9; color: #475569; }
    .comp-table td { padding: 8px; border-bottom: 1px solid #e2e8f0; }
    
    .status-pill { padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: bold; }
    .compliant { background: #dcfce7; color: #166534; }
    .pending { background: #fef3c7; color: #854d0e; }

    .section-head {
      padding: 1.25rem 1rem 0.4rem; font-size: 0.7rem; font-weight: 800;
      color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;
    }

    .activity-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .activity-header {
      padding: 1rem;
      color: white;
      font-weight: bold;
      text-transform: uppercase;
      font-size: 0.875rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .quarter-1 { background: #2563eb; }
    .quarter-2 { background: #10b981; }
    .quarter-3 { background: #f59e0b; }
    .quarter-4 { background: #6366f1; }

    .activity-table {
      display: flex;
      flex-direction: column;
      font-size: 0.75rem;
    }

    .table-header {
      display: flex;
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      font-size: 0.65rem;
      letter-spacing: 0.05em;
    }

    .table-header-cell {
      padding: 0.5rem;
    }

    .table-header-cell:first-child {
      flex: 1;
    }

    .table-header-cell:last-child {
      width: 70px;
      text-align: center;
    }

    .activity-list {
      max-height: 200px;
      overflow-y: auto;
    }

    .activity-list::-webkit-scrollbar { width: 4px; }
    .activity-list::-webkit-scrollbar-track { background: transparent; }
    .activity-list::-webkit-scrollbar-thumb { background-color: #e5e7eb; border-radius: 20px; }

    .activity-row {
      display: flex;
      align-items: center;
      border-bottom: 1px solid #f3f4f6;
      padding: 0.5rem;
      transition: background 0.2s;
    }

    .activity-row:hover {
      background: #f9fafb;
    }

    .activity-text {
      flex: 1;
      font-size: 0.75rem;
      padding-right: 0.5rem;
    }

    .activity-text input {
      width: 100%;
      padding: 0.25rem 0.5rem;
      border: 1px solid transparent;
      border-radius: 4px;
      background: transparent;
      transition: all 0.2s;
    }

    .activity-text input:focus {
      outline: none;
      border-color: #3b82f6;
      background: white;
    }

    .activity-text.completed input {
      text-decoration: line-through;
      color: #9ca3af;
    }

    .activity-status {
      width: 70px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .toggle-switch {
      width: 40px;
      height: 20px;
      background: #d1d5db;
      border-radius: 10px;
      position: relative;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle-switch.active {
      background: #10b981;
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: transform 0.3s;
    }

    .toggle-switch.active::after {
      transform: translateX(20px);
    }

    .add-activity-btn {
      padding: 0.5rem;
      margin: 0.5rem;
      border: 1px dashed #d1d5db;
      border-radius: 6px;
      text-align: center;
      font-size: 0.75rem;
      color: #6b7280;
      cursor: pointer;
      transition: all 0.2s;
    }

    .add-activity-btn:hover {
      border-color: #3b82f6;
      color: #3b82f6;
      background: #f9fafb;
    }

    .magic-btn {
      padding: 0.25rem;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .magic-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .magic-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .logout-btn {
      background: #ef4444;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border: none;
    }

    .logout-btn:hover {
      background: #dc2626;
      transform: translateY(-1px);
      box-shadow: 0 4px 6px rgba(239, 68, 68, 0.3);
    }
  </style>

  <script type="importmap">
  {
    "imports": {
      "@google/genai": "https://esm.sh/@google/genai@^1.33.0",
      "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2"
    }
  }
  </script>
</head>

<body class="flex flex-col min-h-screen bg-gray-100 overflow-hidden">

  <header class="bg-[#0b1a3a] text-white flex items-center justify-between px-6 py-3 shadow-lg z-50">
    <div class="flex items-center space-x-3">
      <img src="image/hsg1.png" alt="Navy" class="h-10 w-10 bg-white rounded-full p-0.5" />
      <h1 class="text-xl font-bold">Philippine Navy Logistics</h1>
    </div>
    <button id="logout-btn" class="logout-btn">
      <i class="fas fa-sign-out-alt"></i>
      <span>Logout</span>
    </button>
  </header>

  <div class="flex flex-1 overflow-hidden">
    
    <aside id="sidebar" class="bg-[#1e293b] w-64 flex-shrink-0 flex flex-col no-scrollbar overflow-y-auto">
      <nav class="flex-1 pb-10">
        <button class="menu-btn w-full flex items-center gap-3 px-4 py-4 text-sm active-tab" data-page="dashboard">
          <i class="fas fa-desktop w-5"></i><span>Dashboard</span>
        </button>

        <div class="section-head">Project Monitoring</div>
        <button class="menu-btn w-full flex items-center gap-3 px-4 py-2 text-sm" data-page="HSGProjectsMonitoring.html"><i class="fas fa-chart-line w-5"></i><span>HSG Project Monitoring</span></button>
        <button class="menu-btn w-full flex items-center gap-3 px-4 py-2 text-sm" data-page="IAPB_Status.html"><i class="fas fa-tasks w-5"></i><span>Activities Implementation</span></button>
        <button class="menu-btn w-full flex items-center gap-3 px-4 py-2 text-sm" data-page="EPA.html"><i class="fas fa-shopping-cart w-5"></i><span>Early Procurement</span></button>
        <button class="menu-btn w-full flex items-center gap-3 px-4 py-2 text-sm" data-page="PNJRRS.html"><i class="fas fa-shield-halved w-5"></i><span>PN Joint Readiness</span></button>

        <div class="section-head">Inventory Reports</div>
        <button class="menu-btn w-full flex items-center gap-3 px-4 py-2 text-sm" data-page="Communication_Inventory.html"><i class="fas fa-broadcast-tower w-5"></i><span>Communication Inv.</span></button>
        <button class="menu-btn w-full flex items-center gap-3 px-4 py-2 text-sm" data-page="FireArms_Inventory.html"><i class="fas fa-crosshairs w-5"></i><span>FireArms Inventory</span></button>
        <button class="menu-btn w-full flex items-center gap-3 px-4 py-2 text-sm" data-page="Vehicle_Inventory.html"><i class="fas fa-car w-5"></i><span>Vehicle Inventory</span></button>

        <div class="section-head">Utilities & Bills</div>
        <button class="menu-btn w-full flex items-center gap-3 px-4 py-2 text-sm" data-page="Meralco.html"><i class="fas fa-bolt-lightning w-5"></i><span>Meralco Bill Report</span></button>
        <button class="menu-btn w-full flex items-center gap-3 px-4 py-2 text-sm" data-page="Maynilad.html"><i class="fas fa-faucet-dotted w-5"></i><span>Maynilad Bill Report</span></button>

        <div class="section-head">Reminders</div>
        <button class="menu-btn w-full flex items-center gap-3 px-4 py-2 text-sm" data-page="BranchCompliances.html"><i class="fas fa-bell w-5"></i><span>Branch Reminders</span></button>
        <button class="menu-btn w-full flex items-center gap-3 px-4 py-2 text-sm" data-page="ConferenceReminders.html"><i class="fas fa-handshake w-5"></i><span>Conference Reminders</span></button>

        <div class="section-head">Document Management</div>
        <button class="menu-btn w-full flex items-center gap-3 px-4 py-2 text-sm" data-page="File_Management.html"><i class="fas fa-file-export w-5"></i><span>Transmittal/Disposition</span></button>
        <button class="menu-btn w-full flex items-center gap-3 px-4 py-2 text-sm" data-page="N4_Scanned_Documents.html"><i class="fas fa-file-pdf w-5"></i><span>N4 Scanned Documents</span></button>
        <button class="menu-btn w-full flex items-center gap-3 px-4 py-2 text-sm" data-page="TNCE_Scanned_Documents.html"><i class="fas fa-file-pdf w-5"></i><span>TNCE Scanned Documents</span></button>
        <button class="menu-btn w-full flex items-center gap-3 px-4 py-2 text-sm" data-page="PPBER_Documents.html"><i class="fas fa-file-pdf w-5"></i><span>PBBER Documents</span></button>



        <div class="section-head">Forms</div>
        <button class="menu-btn w-full flex items-center gap-3 px-4 py-2 text-sm" data-page="UPR_Form.html"><i class="fas fa-file-signature w-5"></i><span>UPR Form</span></button>
        <button class="menu-btn w-full flex items-center gap-3 px-4 py-2 text-sm" data-page="RIS_Form.html"><i class="fas fa-file-invoice w-5"></i><span>RIS Form</span></button>
        <button class="menu-btn w-full flex items-center gap-3 px-4 py-2 text-sm" data-page="PPMP_Form.html"><i class="fas fa-file-contract w-5"></i><span>PPMP Form</span></button>
        <button class="menu-btn w-full flex items-center gap-3 px-4 py-2 text-sm" data-page="DOWNLOAD_CERT">
          <i class="fas fa-certificate w-5"></i><span>PSDBM Certificates</span>
        </button>
      </nav>
    </aside>

    <main class="flex-1 main-content-bg relative overflow-y-auto">
      <div id="dashboard-view" class="p-6" style="padding-right: 200px;">
        <div class="bg-white/80 backdrop-blur-md p-6 rounded-2xl shadow-2xl border border-white mb-6">
          <h2 class="text-3xl font-black text-[#0b1a3a] uppercase">Logistics Unit Data Center</h2>
          <p class="text-gray-600 font-medium">Hover over personnel profiles to view real-time compliance sync.</p>
        </div>

        <div id="activity-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div class="col-span-full text-center py-8">
            <div class="inline-block w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-3 text-gray-500 text-sm">Loading activities...</p>
          </div>
        </div>
      </div>

      <!-- Zoom Conference Widget -->
      <div id="zoom-widget">
        <div class="zoom-header">
          <svg class="zoom-icon" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
            <rect width="200" height="200" rx="40" fill="#2D8CFF"/>
            <path d="M50 60 L140 60 C145 60 150 65 150 70 L150 95 L170 80 L170 120 L150 105 L150 130 C150 135 145 140 140 140 L50 140 C45 140 40 135 40 130 L40 70 C40 65 45 60 50 60 Z" fill="white"/>
          </svg>
          <div>
            <h3 class="font-bold text-sm">Upcoming Conferences</h3>
            <p class="text-xs opacity-90">Next meetings</p>
          </div>
        </div>
        <div id="zoom-body" class="zoom-body">
          <div class="no-conferences">Loading conferences...</div>
        </div>
      </div>

      <div id="branch-compliance-widget">
        <div class="branch-row" onmouseover="loadBranchData('Budget and Fiscal Branch', 'list-budget')">
            <div class="mini-screen">
                <div class="mini-header">BUDGET & FISCAL BRANCH</div>
                <div class="mini-body"><table class="comp-table"><thead><tr><th>Task</th><th>Status</th></tr></thead><tbody id="list-budget"></tbody></table></div>
            </div>
            <div class="portrait-box"><img src="image/pic1.PNG"></div>
        </div>

        <div class="branch-row" onmouseover="loadBranchData('Facility and Maintenance Branch', 'list-facility')">
            <div class="mini-screen">
                <div class="mini-header">FACILITY & MAINTENANCE</div>
                <div class="mini-body"><table class="comp-table"><thead><tr><th>Task</th><th>Status</th></tr></thead><tbody id="list-facility"></tbody></table></div>
            </div>
            <div class="portrait-box"><img src="image/pic2.png"></div>
        </div>

        <div class="branch-row" onmouseover="loadBranchData('Admin and Supply Branch', 'list-admin')">
            <div class="mini-screen">
                <div class="mini-header">ADMIN & SUPPLY</div>
                <div class="mini-body"><table class="comp-table"><thead><tr><th>Task</th><th>Status</th></tr></thead><tbody id="list-admin"></tbody></table></div>
            </div>
            <div class="portrait-box"><img src="image/pic4.png"></div>
        </div>

        <div class="branch-row" onmouseover="loadBranchData('Mobility and POL Branch', 'list-mobility')">
            <div class="mini-screen">
                <div class="mini-header">MOBILITY & POL</div>
                <div class="mini-body"><table class="comp-table"><thead><tr><th>Task</th><th>Status</th></tr></thead><tbody id="list-mobility"></tbody></table></div>
            </div>
            <div class="portrait-box"><img src="image/pic3.png"></div>
        </div>

        <div class="branch-row" onmouseover="loadBranchData('Special Branch', 'list-special')">
            <div class="mini-screen">
                <div class="mini-header">SPECIAL BRANCH REMINDERS</div>
                <div class="mini-body">
                    <table class="comp-table">
                        <thead><tr><th>Task</th><th>Status</th></tr></thead>
                        <tbody id="list-special"><tr><td colspan="2">Fetching...</td></tr></tbody>
                    </table>
                </div>
            </div>
            <div class="portrait-box pulse-gold"><img src="image/pic5.png"></div>
        </div>
      </div>
    </main>

    <div id="iframe-view" class="hidden"></div>
  </div>

  <script type="module">
    import { createClient } from "@supabase/supabase-js";
    import { GoogleGenAI, Type } from "@google/genai";

    const SUPABASE_URL = "https://jdzfxfriydakuqegtahq.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkemZ4ZnJpeWRha3VxZWd0YWhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwODU0MTEsImV4cCI6MjA3NjY2MTQxMX0.8uuX1PUSKOg03AuZeJJ5HxSUhM-gqapTclMn2A3tD4U";
    const sbClient = createClient(SUPABASE_URL, SUPABASE_KEY);
    
    const GOOGLE_API_KEY = 'AIzaSyAK0To2SHndohnCSzMSKjYLeBWjICNHue4';

    document.getElementById('logout-btn').addEventListener('click', () => {
      if (confirm('Are you sure you want to logout?')) {
        window.location.href = 'index.html';
      }
    });

    const buttons = document.querySelectorAll('.menu-btn');
    const iframeView = document.getElementById('iframe-view');
    const dashboard = document.getElementById('dashboard-view');
    const widgetCont = document.getElementById('branch-compliance-widget');
    const zoomWidget = document.getElementById('zoom-widget');

    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        const page = btn.dataset.page;

        if (page === 'DOWNLOAD_CERT') {
            const link = document.createElement('a');
            link.href = 'files/Certificate.docx'; 
            link.download = 'Certificate.docx';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            return;
        }

        buttons.forEach(b => b.classList.remove('active-tab'));
        btn.classList.add('active-tab');

        if (page === 'dashboard') {
          iframeView.classList.add('hidden');
          dashboard.classList.remove('hidden');
          widgetCont.classList.remove('widget-hidden');
          zoomWidget.classList.remove('widget-hidden');
          iframeView.innerHTML = '';
        } else {
          dashboard.classList.add('hidden');
          widgetCont.classList.add('widget-hidden');
          zoomWidget.classList.add('widget-hidden');
          iframeView.classList.remove('hidden');
          iframeView.innerHTML = `<iframe src="${page}" style="width:100%; height:100%; border:none;"></iframe>`;
        }
      });
    });

    window.loadBranchData = async function(branchName, targetId) {
        const tbody = document.getElementById(targetId);
        const currentYear = new Date().getFullYear().toString();
        
        try {
            const { data, error } = await sbClient
                .from('branch_compliances')
                .select('title, status')
                .eq('branch', branchName)
                .eq('year', currentYear);

            if (error) throw error;

            if (!data || data.length === 0) {
                tbody.innerHTML = "<tr><td colspan='2' class='text-center py-4 text-gray-400'>No active reminders</td></tr>";
                return;
            }

            tbody.innerHTML = data.map(item => `
                <tr>
                    <td class="font-medium text-slate-700">${item.title}</td>
                    <td>
                        <span class="status-pill ${item.status === 'Completed' ? 'compliant' : 'pending'}">
                            ${item.status === 'Completed' ? '✓ Done' : '⏳ Pending'}
                        </span>
                    </td>
                </tr>
            `).join('');
        } catch (e) { 
            console.error(e);
            tbody.innerHTML = "<tr><td colspan='2' class='text-red-500'>Connection Error</td></tr>"; 
        }
    }

    const quarters = [
        { id: 'q1', title: '1ST QTR ACTIVITIES', dbValue: 'First Quarter', theme: 'quarter-1', activities: [] },
        { id: 'q2', title: '2ND QTR ACTIVITIES', dbValue: 'Second Quarter', theme: 'quarter-2', activities: [] },
        { id: 'q3', title: '3RD QTR ACTIVITIES', dbValue: 'Third Quarter', theme: 'quarter-3', activities: [] },
        { id: 'q4', title: '4TH QTR ACTIVITIES', dbValue: 'Fourth Quarter', theme: 'quarter-4', activities: [] }
    ];

    const ICONS = {
        magic: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>`,
        plus: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>`,
        loader: `<svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`
    };

    async function fetchActivities() {
        try {
            const { data, error } = await sbClient.from('iapb').select('*').order('id', { ascending: true });
            if (error) throw error;

            quarters.forEach(q => q.activities = []);

            data.forEach(row => {
                const activity = {
                    id: row.id.toString(),
                    text: row.activity_title || '',
                    completed: row.completed === true,
                    quarter_implementation: row.quarter_implementation
                };
                const targetQ = quarters.find(q => q.dbValue === activity.quarter_implementation);
                if (targetQ) targetQ.activities.push(activity);
            });

            renderAllQuarters();
        } catch (err) {
            console.error("Error loading data:", err);
            document.getElementById('activity-grid').innerHTML = `<div class="col-span-full text-center text-red-500 text-sm">Error loading activities.</div>`;
        }
    }

    async function generateSuggestions(quarterIndex) {
        const quarter = quarters[quarterIndex];
        const btn = document.getElementById(`magic-btn-${quarter.id}`);
        
        if (!GOOGLE_API_KEY) {
            alert("API Key is missing.");
            return;
        }

        btn.innerHTML = ICONS.loader;
        btn.disabled = true;

        try {
            const ai = new GoogleGenAI({ apiKey: GOOGLE_API_KEY });
            const response = await ai.models.generateContent({
                model: 'gemini-2.0-flash-exp',
                contents: `Generate 4 specific, actionable activity ideas for the "${quarter.title}" of the year. Keep them short (under 6 words).`,
                config: {
                    responseMimeType: "application/json",
                    responseSchema: { type: Type.ARRAY, items: { type: Type.STRING } }
                }
            });

            const suggestions = JSON.parse(response.text);
            if (Array.isArray(suggestions)) {
                for (const text of suggestions) {
                    await addActivity(quarterIndex, text);
                }
            }
        } catch (err) {
            console.error("AI Error:", err);
            alert("Failed to generate suggestions.");
        } finally {
            btn.innerHTML = ICONS.magic;
            btn.disabled = false;
        }
    }

    async function addActivity(quarterIndex, text = '') {
        const quarter = quarters[quarterIndex];
        const tempId = 'temp-' + Date.now() + Math.random();
        const newActivity = { id: tempId, text, completed: false, quarter_implementation: quarter.dbValue };
        quarter.activities.push(newActivity);
        renderQuarterActivities(quarterIndex);

        const { data, error } = await sbClient.from('iapb').insert([{ 
            activity_title: text, 
            quarter_implementation: quarter.dbValue,
            completed: false
        }]).select().single();

        if (error) {
            console.error("Add failed", error);
            quarter.activities = quarter.activities.filter(a => a.id !== tempId);
            renderQuarterActivities(quarterIndex);
            return;
        }

        const idx = quarter.activities.findIndex(a => a.id === tempId);
        if (idx !== -1) {
            quarter.activities[idx] = {
                id: data.id.toString(),
                text: data.activity_title,
                completed: data.completed,
                quarter_implementation: data.quarter_implementation
            };
            renderQuarterActivities(quarterIndex);
        }
    }

    async function toggleActivity(quarterIndex, activityId) {
        const quarter = quarters[quarterIndex];
        const activity = quarter.activities.find(a => a.id === activityId);
        if (!activity) return;

        activity.completed = !activity.completed;
        renderQuarterActivities(quarterIndex);

        const { error } = await sbClient.from('iapb').update({ completed: activity.completed }).eq('id', activityId);
        if (error) console.error("Toggle failed", error);
    }

    async function updateText(quarterIndex, activityId, newText) {
        const quarter = quarters[quarterIndex];
        const activity = quarter.activities.find(a => a.id === activityId);
        if (!activity) return;

        activity.text = newText;
        await sbClient.from('iapb').update({ activity_title: newText }).eq('id', activityId);
    }

    async function deleteActivity(quarterIndex, activityId) {
        const quarter = quarters[quarterIndex];
        const prevActivities = [...quarter.activities];
        quarter.activities = quarter.activities.filter(a => a.id !== activityId);
        renderQuarterActivities(quarterIndex);

        const { error } = await sbClient.from('iapb').delete().eq('id', activityId);

        if (error) {
            console.error("Delete failed", error);
            quarter.activities = prevActivities;
            renderQuarterActivities(quarterIndex);
        }
    }

    function renderAllQuarters() {
        const container = document.getElementById('activity-grid');
        container.innerHTML = '';
        quarters.forEach((q, index) => {
            container.appendChild(createQuarterElement(q, index));
            renderQuarterActivities(index);
        });
    }

    function createQuarterElement(quarter, index) {
        const el = document.createElement('div');
        el.className = "activity-card";
        el.innerHTML = `
            <div class="activity-header ${quarter.theme}">
                <span>${quarter.title}</span>
                <button id="magic-btn-${quarter.id}" class="magic-btn" title="AI Suggestions">${ICONS.magic}</button>
            </div>
            <div class="activity-table">
                <div class="table-header">
                    <div class="table-header-cell">Activity</div>
                    <div class="table-header-cell">Status</div>
                </div>
                <div id="list-${quarter.id}" class="activity-list"></div>
            </div>
        `;

        el.querySelector(`#magic-btn-${quarter.id}`).addEventListener('click', () => generateSuggestions(index));

        return el;
    }

    function renderQuarterActivities(index) {
        const quarter = quarters[index];
        const listContainer = document.getElementById(`list-${quarter.id}`);
        if (!listContainer) return;

        listContainer.innerHTML = '';

        if (quarter.activities.length === 0) {
            listContainer.innerHTML = `<div class="p-6 text-center text-gray-400 text-xs italic">No activities yet.<br/>Add one or use AI!</div>`;
            return;
        }

        quarter.activities.forEach(activity => {
            const row = document.createElement('div');
            row.className = 'activity-row';
            
            row.innerHTML = `
                <div class="activity-text ${activity.completed ? 'completed' : ''}">
                    <input type="text" value="${activity.text}" placeholder="Enter activity..."/>
                </div>
                <div class="activity-status">
                    <div class="toggle-switch ${activity.completed ? 'active' : ''}"></div>
                </div>
            `;

            const input = row.querySelector('input');
            input.addEventListener('input', (e) => updateText(index, activity.id, e.target.value));

            const toggle = row.querySelector('.toggle-switch');
            toggle.addEventListener('click', () => toggleActivity(index, activity.id));

            listContainer.appendChild(row);
        });
    }

    // -------------------------------
    // Load Conference Widget Data
    // -------------------------------
    async function loadConferences() {
      const zoomBody = document.getElementById('zoom-body');
      
      try {
        const { data, error } = await sbClient
          .from('conferences')
          .select('*')
          .order('datetime', { ascending: true })
          .limit(5);

        if (error) throw error;

        if (!data || data.length === 0) {
          zoomBody.innerHTML = '<div class="no-conferences">No upcoming conferences</div>';
          return;
        }

        zoomBody.innerHTML = data.map(conf => {
          const dateObj = new Date(conf.datetime);
          const formattedDate = dateObj.toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric',
            year: 'numeric'
          });
          const formattedTime = dateObj.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit' 
          });

          return `
            <div class="conference-item">
              <div class="conference-title">${conf.title}</div>
              <div class="conference-date">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                ${formattedDate} at ${formattedTime}
              </div>
              <div class="conference-location">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                ${conf.location}
              </div>
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Conference load error:', err);
        zoomBody.innerHTML = '<div class="no-conferences">Error loading conferences</div>';
      }
    }

    fetchActivities();
    loadConferences();
    
  </script>
</body>

</html>
