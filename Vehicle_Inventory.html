<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Inventory - Philippine Navy</title>
    <style>
    body {
        background-image: url('image/bg4.jpg');
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        background-repeat: no-repeat;
        min-height: 100vh;
    }

    .container {
        background-color: rgba(255, 255, 255, 0.95); 
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f3f4f6;
        color: #1f2937;
        line-height: 1.6;
        min-height: 100vh;
    }
    .container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }
    h1 { color: #0b1a3a; font-weight: 600; margin-bottom: 1.5rem; font-size: 2rem; }

    .card {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid #e5e7eb;
    }
    .card-header {
        background: linear-gradient(135deg, #0b1a3a 0%, #1e3a8a 100%);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 0.5rem 0.5rem 0 0;
        margin: -1.5rem -1.5rem 1.5rem -1.5rem;
        font-weight: 600;
        border-left: 4px solid #f1c232;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1.25rem;
        font-size: 0.875rem;
        font-weight: 500;
        border-radius: 0.375rem;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .btn-primary { background-color: #0b1a3a; color: white; }
    .btn-dark { background-color: #374151; color: white; }
    .btn-accent { background-color: #10b981; color: white; }
    .btn-danger { background-color: #ef4444; color: white; }
    .btn-info { background-color: #06b6d4; color: white; }
    .btn-warning { background-color: #f59e0b; color: white; }
    .btn-edit { background-color: #8b5cf6; color: white; font-size: 0.75rem; padding: 0.4rem 0.8rem; }
    .btn-group { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1.5rem; }

    .form-control {
        display: block;
        width: 100%;
        padding: 0.625rem 0.875rem;
        font-size: 0.875rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
    }
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    .form-select {
        padding: 0.625rem;
        border-radius: 0.375rem;
        border: 1px solid #d1d5db;
        min-width: 200px;
        background-color: white;
    }

    .table-responsive { overflow-x: auto; margin-bottom: 1.5rem; border-radius: 0.375rem; }
    .table { width: 100%; border-collapse: collapse; background-color: white; font-size: 0.875rem; }
    .table thead { background: #0b1a3a; color: white; }
    .table th, .table td { padding: 0.875rem 1rem; text-align: center; border-bottom: 1px solid #e5e7eb; }
    
    .alert {
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
    }
    .alert-success { background-color: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
    .alert-error { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
    .alert-info { background-color: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
    
    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
        animation: fadeIn 0.3s;
    }
    
    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 0;
        border-radius: 0.5rem;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        animation: slideDown 0.3s;
    }
    
    .modal-header {
        background: linear-gradient(135deg, #0b1a3a 0%, #1e3a8a 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 0.5rem 0.5rem 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-body {
        padding: 1.5rem;
    }
    
    .modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid #e5e7eb;
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
    }
    
    .close {
        color: white;
        font-size: 2rem;
        font-weight: bold;
        cursor: pointer;
        background: none;
        border: none;
        padding: 0;
        line-height: 1;
    }
    
    .close:hover {
        opacity: 0.8;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes slideDown {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    @media (max-width: 768px) {
        .form-grid { grid-template-columns: 1fr; }
        .btn { width: 100%; justify-content: center; }
        .modal-content { width: 95%; margin: 10% auto; }
    }
    </style>
</head>
<body>

<div class="container">
    <h1>üöó Vehicle Inventory</h1>

    <div id="alertContainer"></div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
        <div class="card" style="margin-bottom: 0;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div style="background: #0b1a3a; color: white; width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem;">üöó</div>
                <div>
                    <p style="font-size: 0.875rem; color: #6b7280;">Total Fleet</p>
                    <p style="font-size: 2rem; font-weight: 700;" id="totalVehicles">0</p>
                </div>
            </div>
        </div>
        <div class="card" style="margin-bottom: 0;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div style="background: #10b981; color: white; width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem;">üè¢</div>
                <div>
                    <p style="font-size: 0.875rem; color: #6b7280;">Active Offices</p>
                    <p style="font-size: 2rem; font-weight: 700;" id="totalOffices">0</p>
                </div>
            </div>
        </div>
        <div class="card" style="margin-bottom: 0;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div style="background: #f59e0b; color: white; width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem;">üîó</div>
                <div>
                    <p style="font-size: 0.875rem; color: #6b7280;">Database Status</p>
                    <p style="font-size: 1.2rem; font-weight: 700;" id="dbStatus">Checking...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="card" style="padding: 1rem; display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; background-color: #ebf0f7;">
        <select id="officeFilterDropdown" class="form-select">
            <option value="">-- All Offices --</option>
            <option value="FOIC">FOIC</option>
            <option value="VCOM">VCOM</option>
            <option value="CNS">CNS</option>
            <option value="N1">N1</option>
            <option value="N2">N2</option>
            <option value="N3">N3</option>
            <option value="N4">N4</option>
            <option value="N5">N5</option>
            <option value="N6">N6</option>
            <option value="N7">N7</option>
            <option value="N8">N8</option>
            <option value="N9">N9</option>
            <option value="N10">N10</option>
            <option value="N11">N11</option>
            <option value="HSG">HSG</option>
            <option value="NIOFC">NIOFC</option>
            <option value="CMCPO">CMCPO</option>
            <option value="CRDO">CRDO</option>
            <option value="CNLE">CNLE</option>
            <option value="NSPAO">NSPAO</option>
            <option value="NPAO">NPAO</option>
            <option value="ONSSSM">ONSSSM</option>
            <option value="NJAG">NJAG</option>
            <option value="TNCH">TNCH</option>
            <option value="TCSN">TCSN</option>
            <option value="TCNN">TCNN</option>
            <option value="TCDSN">TCDSN</option>
            <option value="TNCE">TNCE</option>
            <option value="PNOLOAC">PNOLOAC</option>
            <option value="TNIA">TNIA</option>
            <option value="NSO">NSO</option>
            <option value="NASO">NASO</option>
            <option value="TNIG">TNIG</option>
            <option value="OESPA">OESPA</option>
            <option value="TNPM">TNPM</option>
            <option value="OTNA">OTNA</option>
            <option value="PNGADC">PNGADC</option>
            <option value="PNREO">PNREO</option>
            <option value="PNMO">PNMO</option>
            <option value="ONIA">ONIA</option>
            <option value="FMWC">FMWC</option>
            <option value="PNMCMC">PNMCMC</option>
        </select>
        <input type="text" id="plateSearchInput" class="form-control" style="max-width: 250px;" placeholder="Search Plate Number...">
        <button type="button" id="searchBtn" class="btn btn-accent">üîç Search</button>
        <button type="button" id="clearFilter" class="btn btn-primary">‚úñ Reset</button>
    </div>

    <div class="card">
        <div class="card-header">Add New Vehicle Entry</div>
        <form id="addForm" class="form-grid">
            <input id="office" class="form-control" placeholder="Office (e.g. N1)" required>
            <input id="vehicle_type" class="form-control" placeholder="Vehicle Type (e.g. SUV)" required>
            <input id="plate_number" class="form-control" placeholder="Plate Number">
            <input id="engine_number" class="form-control" placeholder="Engine Number">
            <input id="chassis_number" class="form-control" placeholder="Chassis Number">
            <input id="remarks" class="form-control" placeholder="Remarks/Status">
            <input id="date_of_registration" class="form-control" type="date">
            <button type="submit" class="btn btn-primary">‚ûï Add Vehicle</button>
        </form>
    </div>

    <div class="btn-group">
        <button onclick="exportToExcel()" class="btn btn-dark">üìä Export to Excel</button>
        <button onclick="downloadTemplate()" class="btn btn-info">üìã Download Template</button>
        <button onclick="document.getElementById('excelUpload').click()" class="btn btn-warning">üì§ Import from Excel</button>
        <input type="file" id="excelUpload" accept=".xlsx,.xls,.csv" style="display:none" onchange="importExcel(event)">
        <button onclick="deleteSelected()" class="btn btn-danger">üóë Delete Selected</button>
        <button onclick="testConnection()" class="btn btn-accent">üîß Test Connection</button>
    </div>

    <div class="card">
        <div class="card-header">Fleet Records Table</div>
        <div class="table-responsive">
            <table class="table" id="inventoryTable">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll"></th>
                        <th>#</th>
                        <th>Office</th>
                        <th>Type</th>
                        <th>Plate</th>
                        <th>Engine</th>
                        <th>Chassis</th>
                        <th>Remarks</th>
                        <th>Reg. Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="vehicleTable"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 style="margin: 0; font-size: 1.25rem;">‚úèÔ∏è Edit Vehicle Record</h2>
            <button class="close" onclick="closeEditModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editForm" class="form-grid">
                <input type="hidden" id="edit_id">
                <div>
                    <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500;">Office</label>
                    <input id="edit_office" class="form-control" required>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500;">Vehicle Type</label>
                    <input id="edit_vehicle_type" class="form-control" required>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500;">Plate Number</label>
                    <input id="edit_plate_number" class="form-control">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500;">Engine Number</label>
                    <input id="edit_engine_number" class="form-control">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500;">Chassis Number</label>
                    <input id="edit_chassis_number" class="form-control">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500;">Remarks</label>
                    <input id="edit_remarks" class="form-control">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500;">Registration Date</label>
                    <input id="edit_date_of_registration" class="form-control" type="date">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-dark" onclick="closeEditModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveEdit()">üíæ Save Changes</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    const SB_URL = "https://jdzfxfriydakuqegtahq.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkemZ4ZnJpeWRha3VxZWd0YWhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwODU0MTEsImV4cCI6MjA3NjY2MTQxMX0.8uuX1PUSKOg03AuZeJJ5HxSUhM-gqapTclMn2A3tD4U";

    const db = window.supabase.createClient(SB_URL, SB_KEY);
    const activeYear = new Date().getFullYear();

    function showAlert(message, type) {
        const alertContainer = document.getElementById('alertContainer');
        const alert = document.createElement('div');
        alert.className = 'alert alert-' + type;
        alert.textContent = message;
        alertContainer.appendChild(alert);
        setTimeout(function() {
            alert.remove();
        }, 5000);
    }

    async function testConnection() {
        showAlert('Testing database connection...', 'info');
        try {
            const result = await db.from('vehicles').select('count', { count: 'exact', head: true });
            if (result.error) throw result.error;
            showAlert('‚úÖ Database connection successful!', 'success');
            document.getElementById('dbStatus').textContent = '‚úÖ Connected';
            document.getElementById('dbStatus').style.color = '#10b981';
        } catch (err) {
            showAlert('‚ùå Connection failed: ' + err.message, 'error');
            document.getElementById('dbStatus').textContent = '‚ùå Error';
            document.getElementById('dbStatus').style.color = '#ef4444';
            console.error('Connection error:', err);
        }
    }

    document.getElementById("searchBtn").onclick = function() {
        const officeFilter = document.getElementById("officeFilterDropdown").value.trim().toUpperCase();
        const plateFilter = document.getElementById("plateSearchInput").value.trim().toUpperCase();
        const rows = document.querySelectorAll("#vehicleTable tr");
        let foundCount = 0;

        rows.forEach(function(row) {
            if (row.cells.length < 5) return;
            const officeText = row.cells[2].textContent.trim().toUpperCase();
            const plateText = row.cells[4].textContent.trim().toUpperCase();
            const matchesOffice = !officeFilter || officeText === officeFilter;
            const matchesPlate = !plateFilter || plateText.includes(plateFilter);

            if (matchesOffice && matchesPlate) {
                row.style.display = "";
                foundCount++;
            } else {
                row.style.display = "none";
            }
        });

        if (foundCount === 0) {
            showAlert("No matching records found.", 'info');
        } else {
            showAlert('Found ' + foundCount + ' matching records.', 'success');
        }
    };

    document.getElementById("clearFilter").onclick = function() {
        document.getElementById("officeFilterDropdown").value = "";
        document.getElementById("plateSearchInput").value = "";
        document.querySelectorAll("#vehicleTable tr").forEach(function(row) {
            row.style.display = "";
        });
        showAlert("Filters cleared.", 'info');
    };

    async function refreshData() {
        const tbody = document.getElementById("vehicleTable");
        tbody.innerHTML = "<tr><td colspan='10' style='padding:2rem;'>Fetching Data...</td></tr>";

        try {
            const result = await db
                .from('vehicles')
                .select('*')
                .eq('year', activeYear)
                .order('id', { ascending: true });
            
            if (result.error) throw result.error;
            
            const data = result.data;
            tbody.innerHTML = "";

            if (!data || data.length === 0) {
                tbody.innerHTML = "<tr><td colspan='10' style='padding:2rem;'>No records found for " + activeYear + ".</td></tr>";
                updateStats([]);
                document.getElementById('dbStatus').textContent = '‚úÖ Connected';
                document.getElementById('dbStatus').style.color = '#10b981';
                return;
            }

            data.forEach(function(v, idx) {
                const row = tbody.insertRow();
                row.dataset.id = v.id;
                row.innerHTML = '<td><input type="checkbox" class="rowCheckbox"></td>' +
                    '<td>' + (idx + 1) + '</td>' +
                    '<td><strong>' + (v.office || '') + '</strong></td>' +
                    '<td>' + (v.vehicle_type || '') + '</td>' +
                    '<td>' + (v.plate_number || '') + '</td>' +
                    '<td>' + (v.engine_number || '') + '</td>' +
                    '<td>' + (v.chassis_number || '') + '</td>' +
                    '<td>' + (v.remarks || '') + '</td>' +
                    '<td>' + (v.date_of_registration || '') + '</td>' +
                    '<td><button class="btn btn-edit" onclick="openEditModal(' + v.id + ')">‚úèÔ∏è Edit</button></td>';
            });
            updateStats(data);
            document.getElementById('dbStatus').textContent = '‚úÖ Connected';
            document.getElementById('dbStatus').style.color = '#10b981';
        } catch (err) {
            tbody.innerHTML = '<tr><td colspan="10" style="color:red; padding:2rem;">Error: ' + err.message + '</td></tr>';
            showAlert('Error loading data: ' + err.message, 'error');
            document.getElementById('dbStatus').textContent = '‚ùå Error';
            document.getElementById('dbStatus').style.color = '#ef4444';
            console.error('Refresh error:', err);
        }
    }

    document.getElementById("addForm").onsubmit = async function(e) {
        e.preventDefault();
        const payload = {
            office: document.getElementById("office").value.toUpperCase(),
            vehicle_type: document.getElementById("vehicle_type").value,
            plate_number: document.getElementById("plate_number").value,
            engine_number: document.getElementById("engine_number").value,
            chassis_number: document.getElementById("chassis_number").value,
            remarks: document.getElementById("remarks").value,
            date_of_registration: document.getElementById("date_of_registration").value || null,
            year: activeYear
        };

        try {
            const result = await db.from('vehicles').insert([payload]).select();
            if (result.error) throw result.error;
            showAlert('‚úÖ Vehicle added successfully!', 'success');
            document.getElementById("addForm").reset();
            refreshData();
        } catch (err) {
            showAlert('‚ùå Error adding vehicle: ' + err.message, 'error');
            console.error('Insert error:', err);
        }
    };

    function updateStats(data) {
        document.getElementById('totalVehicles').textContent = data.length;
        const offices = [];
        data.forEach(function(v) {
            if (v.office && offices.indexOf(v.office) === -1) {
                offices.push(v.office);
            }
        });
        document.getElementById('totalOffices').textContent = offices.length;
    }

    async function deleteSelected() {
        const checked = document.querySelectorAll(".rowCheckbox:checked");
        if (checked.length === 0) {
            showAlert("Please select records to delete.", 'info');
            return;
        }
        if (confirm('Delete ' + checked.length + ' records? This cannot be undone.')) {
            try {
                const ids = [];
                checked.forEach(function(c) {
                    ids.push(parseInt(c.closest("tr").dataset.id));
                });
                const result = await db.from('vehicles').delete().in('id', ids);
                if (result.error) throw result.error;
                showAlert('‚úÖ ' + checked.length + ' records deleted successfully!', 'success');
                refreshData();
            } catch (err) {
                showAlert('‚ùå Error deleting records: ' + err.message, 'error');
                console.error('Delete error:', err);
            }
        }
    }

    // Edit Modal Functions
    async function openEditModal(id) {
        try {
            const result = await db.from('vehicles').select('*').eq('id', id).single();
            if (result.error) throw result.error;
            
            const vehicle = result.data;
            document.getElementById('edit_id').value = vehicle.id;
            document.getElementById('edit_office').value = vehicle.office || '';
            document.getElementById('edit_vehicle_type').value = vehicle.vehicle_type || '';
            document.getElementById('edit_plate_number').value = vehicle.plate_number || '';
            document.getElementById('edit_engine_number').value = vehicle.engine_number || '';
            document.getElementById('edit_chassis_number').value = vehicle.chassis_number || '';
            document.getElementById('edit_remarks').value = vehicle.remarks || '';
            document.getElementById('edit_date_of_registration').value = vehicle.date_of_registration || '';
            
            document.getElementById('editModal').style.display = 'block';
        } catch (err) {
            showAlert('‚ùå Error loading vehicle data: ' + err.message, 'error');
            console.error('Load error:', err);
        }
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
        document.getElementById('editForm').reset();
    }

    async function saveEdit() {
        const id = parseInt(document.getElementById('edit_id').value);
        const payload = {
            office: document.getElementById('edit_office').value.toUpperCase(),
            vehicle_type: document.getElementById('edit_vehicle_type').value,
            plate_number: document.getElementById('edit_plate_number').value,
            engine_number: document.getElementById('edit_engine_number').value,
            chassis_number: document.getElementById('edit_chassis_number').value,
            remarks: document.getElementById('edit_remarks').value,
            date_of_registration: document.getElementById('edit_date_of_registration').value || null
        };

        try {
            const result = await db.from('vehicles').update(payload).eq('id', id).select();
            if (result.error) throw result.error;
            showAlert('‚úÖ Vehicle updated successfully!', 'success');
            closeEditModal();
            refreshData();
        } catch (err) {
            showAlert('‚ùå Error updating vehicle: ' + err.message, 'error');
            console.error('Update error:', err);
        }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('editModal');
        if (event.target === modal) {
            closeEditModal();
        }
    }

    function exportToExcel() {
        const wb = XLSX.utils.table_to_book(document.getElementById("inventoryTable"));
        XLSX.writeFile(wb, 'PN_Fleet_Inventory_' + activeYear + '.xlsx');
        showAlert('‚úÖ Excel file exported successfully!', 'success');
    }

    function downloadTemplate() {
        const template = [
            ['Office', 'Vehicle Type', 'Plate Number', 'Engine Number', 'Chassis Number', 'Remarks', 'Date of Registration'],
            ['FOIC', 'Sedan', 'ABC-1234', 'ENG-001', 'CHS-001', 'Good condition', '2025-01-15'],
            ['VCOM', 'Truck', 'XYZ-5678', 'ENG-002', 'CHS-002', 'Regular maintenance', '2025-02-20'],
            ['', '', '', '', '', '', '']
        ];
        
        const ws = XLSX.utils.aoa_to_sheet(template);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Vehicles');
        XLSX.writeFile(wb, 'Vehicle_Import_Template.xlsx');
        showAlert('üìã Template downloaded! Fill it out and import back.', 'info');
    }

    async function importExcel(event) {
        const file = event.target.files[0];
        if (!file) return;

        showAlert('üì§ Importing data from Excel...', 'info');

        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(firstSheet);

                if (rows.length === 0) {
                    showAlert('‚ùå No data found in the Excel file.', 'error');
                    return;
                }

                const vehicles = [];
                rows.forEach(function(row) {
                    const office = (row['Office'] || row['office'] || '').toString().toUpperCase();
                    const vehicleType = (row['Vehicle Type'] || row['vehicle_type'] || '').toString();
                    
                    if (office || vehicleType) {
                        vehicles.push({
                            office: office,
                            vehicle_type: vehicleType,
                            plate_number: (row['Plate Number'] || row['plate_number'] || '').toString(),
                            engine_number: (row['Engine Number'] || row['engine_number'] || '').toString(),
                            chassis_number: (row['Chassis Number'] || row['chassis_number'] || '').toString(),
                            remarks: (row['Remarks'] || row['remarks'] || '').toString(),
                            date_of_registration: (row['Date of Registration'] || row['date_of_registration'] || '').toString(),
                            year: activeYear
                        });
                    }
                });

                if (vehicles.length === 0) {
                    showAlert('‚ùå No valid vehicle data found in file.', 'error');
                    return;
                }

                const result = await db.from('vehicles').insert(vehicles).select();
                if (result.error) throw result.error;

                showAlert('‚úÖ Successfully imported ' + vehicles.length + ' vehicles!', 'success');
                refreshData();
                event.target.value = '';
            } catch (err) {
                showAlert('‚ùå Import error: ' + err.message, 'error');
                console.error('Import error:', err);
                event.target.value = '';
            }
        };
        reader.readAsArrayBuffer(file);
    }

    document.getElementById("selectAll").onchange = function() {
        const isChecked = this.checked;
        document.querySelectorAll(".rowCheckbox").forEach(function(c) {
            c.checked = isChecked;
        });
    };

    testConnection();
    refreshData();
</script>
</body>
</html>
