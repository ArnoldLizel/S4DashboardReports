<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quartermaster Inventory Report</title>

<link rel="stylesheet" href="navy-dashboard-styles.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  body { padding: 1rem; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
  .page-header { text-align: center; margin-bottom: 2rem; }
  .page-header h1 { color: #0b1a3a; font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem; text-transform: uppercase; }
  .page-header p { color: #6b7280; font-size: 0.95rem; }

  .office-selector { background: #f9fafb; padding: 1rem 1.5rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; margin-bottom: 1.5rem; }
  .office-selector label { font-weight: 600; color: #374151; margin-right: 0.75rem; }
  .office-selector select { width: 100%; max-width: 400px; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; }

  .autosave-section { display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 0.375rem; margin-bottom: 1rem; }
  
  .table th { text-align: center; background-color: #f8fafc; font-size: 0.85rem; color: #475569; }
  .table td { text-align: center; vertical-align: middle; }
  .table td.item-name { text-align: left; font-weight: 600; color: #1f2937; padding-left: 1rem; }
  
  /* Sub-header rows from your screenshot (where colspan is true) */
  .sub-header-row td { background: #f1f5f9 !important; font-weight: 700; color: #1e293b; text-align: left !important; border-left: 4px solid #0b1a3a; }

  input.qty-input { width: 90px; padding: 0.4rem; text-align: center; border: 1px solid #cbd5e1; border-radius: 0.25rem; font-weight: 600; }
  input.qty-input:focus { border-color: #2563eb; outline: none; box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1); }

  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
  .stat-card { background: #0b1a3a; color: white; padding: 1rem; border-radius: 0.5rem; }
  .stat-card .stat-value { font-size: 1.25rem; font-weight: 800; }

  .loading-overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(255,255,255,0.7); z-index: 9999; }
  .loading-overlay.show { display: flex; }
  .toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 10000; }
</style>
</head>
<body>

<div class="loading-overlay" id="loader"><div class="spinner"></div></div>

<div class="container">
  <div class="page-header">
    <h1><i class="fas fa-boxes"></i> Quartermaster Reports</h1>
    <p>Inventory Tracking for Office Furniture & Equipment</p>
  </div>

  <div class="card">
    <div class="card-body">
      <div class="office-selector">
        <label for="officeSelect"><i class="fas fa-building"></i> Select Office:</label>
        <select id="officeSelect" class="form-select">
          <option value="">-- Loading Offices... --</option>
        </select>
      </div>

      <div class="autosave-section">
        <input type="checkbox" id="autosaveToggle" checked />
        <label for="autosaveToggle" style="cursor:pointer"><strong>Auto-save enabled</strong> (1.2s delay)</label>
      </div>

      <div class="d-flex gap-2 mb-3">
        <button class="btn btn-success" id="saveBtn"><i class="fas fa-save"></i> Save All</button>
        <button class="btn btn-outline-primary" id="exportBtn"><i class="fas fa-file-export"></i> CSV Export</button>
        <button class="btn btn-outline-danger" id="clearBtn"><i class="fas fa-eraser"></i> Clear Data</button>
      </div>
    </div>
  </div>

  <div class="stats-grid" id="statsGrid" style="display: none;">
    <div class="stat-card">
      <div class="small">Unique Items</div>
      <div class="stat-value" id="statCount">0</div>
    </div>
    <div class="stat-card">
      <div class="small">Total TE 2019</div>
      <div class="stat-value" id="stat19">0</div>
    </div>
    <div class="stat-card">
      <div class="small">Total On Hand</div>
      <div class="stat-value" id="statOH">0</div>
    </div>
    <div class="stat-card">
      <div class="small">Total TE 2025</div>
      <div class="stat-value" id="stat25">0</div>
    </div>
  </div>

  <div class="card">
    <div class="table-responsive">
      <table class="table" id="inventoryTable">
        <thead>
          <tr>
            <th style="width: 40%;">Item Description</th>
            <th style="width: 20%;">TE 2019</th>
            <th style="width: 20%;">On Hand</th>
            <th style="width: 20%;">TE 2025</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr><td colspan="4" class="text-center p-5">Please select an office to load inventory data.</td></tr>
        </tbody>
      </table>
    </div>
    <div class="card-footer d-flex justify-content-between">
      <span id="lastSaved" class="text-muted small"></span>
      <span class="text-muted small"><i class="fas fa-info-circle"></i> Changes are tracked by Item ID</span>
    </div>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
/* ---------- CONFIG (SQL MAPPED) ---------- */
const SUPABASE_URL = "https://jdzfxfriydakuqegtahq.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkemZ4ZnJpeWRha3VxZWd0YWhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwODU0MTEsImV4cCI6MjA3NjY2MTQxMX0.8uuX1PUSKOg03AuZeJJ5HxSUhM-gqapTclMn2A3tD4U";

const T_OFFICES = "offices";
const T_ITEMS = "quartermaster_items";
const T_DATA = "office_quartermaster"; // Your Bridge Table

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ---------- STATE ---------- */
let masterItems = [];
let officeMap = {};
let currentOfficeId = null;
let valuesStore = {}; // Keyed by item_id
let autoSaveTimer = null;

/* ---------- INITIALIZATION ---------- */
async function init() {
    showLoader(true);
    try {
        // 1. Load Offices
        const { data: offData } = await supabase.from(T_OFFICES).select("id, office_name").order('office_name');
        const select = document.getElementById('officeSelect');
        select.innerHTML = '<option value="">-- Choose an Office --</option>';
        offData.forEach(o => {
            officeMap[o.id] = o.office_name;
            let opt = new Option(o.office_name, o.id);
            select.add(opt);
        });

        // 2. Load Master Items (for the table structure)
        const { data: itemData } = await supabase.from(T_ITEMS).select("*").order('id');
        masterItems = itemData || [];

        select.addEventListener('change', (e) => loadInventory(e.target.value));
        document.getElementById('saveBtn').addEventListener('click', saveData);
        document.getElementById('exportBtn').addEventListener('click', exportCSV);
        document.getElementById('clearBtn').addEventListener('click', clearData);

    } catch (err) {
        console.error(err);
    } finally {
        showLoader(false);
    }
}

/* ---------- DATA LOADING ---------- */
async function loadInventory(officeId) {
    if (!officeId) {
        currentOfficeId = null;
        renderTable();
        return;
    }
    currentOfficeId = officeId;
    showLoader(true);

    try {
        const { data, error } = await supabase
            .from(T_DATA)
            .select("*")
            .eq('office_id', officeId);

        if (error) throw error;

        // Reset store and populate with existing SQL records
        valuesStore = {};
        (data || []).forEach(row => {
            valuesStore[row.item_id] = {
                te_2019: row.te_2019,
                onhand: row.onhand,
                proposed_te_2025: row.proposed_te_2025
            };
        });

        renderTable();
    } catch (err) {
        notify("Error loading data", "danger");
    } finally {
        showLoader(false);
    }
}

/* ---------- RENDERING ---------- */
function renderTable() {
    const tbody = document.getElementById('tableBody');
    const stats = document.getElementById('statsGrid');
    
    if (!currentOfficeId) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center p-5">Select an office to begin.</td></tr>';
        stats.style.display = 'none';
        return;
    }

    stats.style.display = 'grid';
    tbody.innerHTML = "";

    masterItems.forEach(item => {
        const tr = document.createElement('tr');
        
        if (item.colspan) {
            tr.className = "sub-header-row";
            tr.innerHTML = `<td colspan="4"><i class="fas fa-folder-open"></i> ${item.item_name}</td>`;
        } else {
            const val = valuesStore[item.id] || { te_2019: 0, onhand: 0, proposed_te_2025: 0 };
            tr.innerHTML = `
                <td class="item-name">${item.item_name}</td>
                <td><input type="number" class="qty-input" value="${val.te_2019}" oninput="updateStore(${item.id}, 'te_2019', this.value)"></td>
                <td><input type="number" class="qty-input" value="${val.onhand}" oninput="updateStore(${item.id}, 'onhand', this.value)"></td>
                <td><input type="number" class="qty-input" value="${val.proposed_te_2025}" oninput="updateStore(${item.id}, 'proposed_te_2025', this.value)"></td>
            `;
        }
        tbody.appendChild(tr);
    });
    updateStats();
}

/* ---------- EVENT HANDLERS ---------- */
function updateStore(itemId, field, value) {
    if (!valuesStore[itemId]) valuesStore[itemId] = { te_2019: 0, onhand: 0, proposed_te_2025: 0 };
    valuesStore[itemId][field] = parseInt(value) || 0;
    
    updateStats();

    if (document.getElementById('autosaveToggle').checked) {
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(saveData, 1200);
    }
}

async function saveData() {
    if (!currentOfficeId) return;

    // Convert store to SQL-ready records
    const records = Object.keys(valuesStore).map(itemId => ({
        office_id: currentOfficeId,
        item_id: itemId,
        te_2019: valuesStore[itemId].te_2019,
        onhand: valuesStore[itemId].onhand,
        proposed_te_2025: valuesStore[itemId].proposed_te_2025
    }));

    try {
        // Use your UNIQUE constraint to upsert or delete/insert
        const { error: delError } = await supabase.from(T_DATA).delete().eq('office_id', currentOfficeId);
        if (delError) throw delError;

        if (records.length > 0) {
            const { error: insError } = await supabase.from(T_DATA).insert(records);
            if (insError) throw insError;
        }

        document.getElementById('lastSaved').textContent = `Saved at ${new Date().toLocaleTimeString()}`;
    } catch (err) {
        notify("Save Failed", "danger");
    }
}

function updateStats() {
    let count = 0, t19 = 0, toh = 0, t25 = 0;
    Object.values(valuesStore).forEach(v => {
        count++;
        t19 += v.te_2019;
        toh += v.onhand;
        t25 += v.proposed_te_2025;
    });
    document.getElementById('statCount').textContent = count;
    document.getElementById('stat19').textContent = t19;
    document.getElementById('statOH').textContent = toh;
    document.getElementById('stat25').textContent = t25;
}

function notify(msg, type) {
    const container = document.getElementById('toastContainer');
    container.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
    setTimeout(() => container.innerHTML = "", 3000);
}

function showLoader(show) {
    document.getElementById('loader').classList.toggle('show', show);
}

async function clearData() {
    if (!confirm("Are you sure? This deletes ALL records for this office in the database.")) return;
    await supabase.from(T_DATA).delete().eq('office_id', currentOfficeId);
    valuesStore = {};
    renderTable();
}

function exportCSV() {
    const officeName = officeMap[currentOfficeId] || "Export";
    let csv = "Item ID, Item Description, TE 2019, On Hand, TE 2025\n";
    masterItems.forEach(item => {
        if (!item.colspan) {
            const v = valuesStore[item.id] || { te_2019:0, onhand:0, proposed_te_2025:0 };
            csv += `${item.id}, "${item.item_name}", ${v.te_2019}, ${v.onhand}, ${v.proposed_te_2025}\n`;
        }
    });
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `${officeName}_Inventory.csv`; a.click();
}

init();
</script>

</body>
</html>