<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Quartermaster | Admin Console</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <style>
        /* BASE STYLES */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh; padding: 1.5rem;
        }
        .app-container { max-width: 1600px; margin: 0 auto; display: grid; grid-template-columns: 320px 1fr; gap: 1.5rem; }
        .sidebar { background: white; border-radius: 1rem; padding: 2rem; box-shadow: 0 20px 60px rgba(0,0,0,0.15); position: sticky; top: 1.5rem; }
        .logo-section { text-align: center; margin-bottom: 2rem; border-bottom: 2px solid #f3f4f6; padding-bottom: 1.5rem; }
        
        /* BUTTONS & FORMS */
        .btn { padding: 0.75rem 1rem; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: 0.2s; width: 100%; margin-bottom: 0.75rem; }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-manage { background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .form-select { width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 2px solid #e5e7eb; margin-bottom: 1.5rem; }

        /* MAIN TABLE */
        .main-content { background: white; border-radius: 1rem; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.15); }
        .content-header { padding: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .inventory-table { width: 100%; border-collapse: collapse; }
        .inventory-table th { padding: 1rem; background: #f9fafb; border-bottom: 2px solid #e5e7eb; position: sticky; top: 0; }
        .inventory-table td { padding: 0.8rem; border-bottom: 1px solid #f3f4f6; text-align: center; }
        .category-row td { background: #667eea !important; color: white !important; text-align: left !important; font-weight: bold; }
        .qty-input { width: 70px; padding: 0.3rem; text-align: center; border: 1px solid #ddd; }

        /* MODALS */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 1rem; padding: 2rem; width: 95%; max-width: 1000px; max-height: 90vh; overflow-y: auto; }
        
        /* DRAG & DROP STYLES */
        .sortable-item { cursor: grab; background: white; transition: background 0.2s; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; padding: 10px; }
        .sortable-item:active { cursor: grabbing; }
        .sortable-ghost { opacity: 0.4; background: #e0e7ff; }

        /* SUMMARY CARDS */
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem; }
        .summary-card { padding: 1rem; background: #f8fafc; border-radius: 0.5rem; text-align: center; border-bottom: 4px solid #10b981; }

        /* PRINT LOGIC - CRITICAL FIX */
        @media print {
            body * { visibility: hidden; background: white !important; }
            .modal.show, .modal.show * { visibility: visible; }
            .modal.show { position: absolute; left: 0; top: 0; width: 100%; display: block !important; }
            .modal-content { box-shadow: none !important; width: 100% !important; max-width: 100% !important; border: none !important; overflow: visible !important; }
            .no-print { display: none !important; }
            .inventory-table { width: 100% !important; border: 1px solid #000; }
            .inventory-table th, .inventory-table td { border: 1px solid #ccc !important; padding: 8px !important; color: black !important; }
            .category-row td { background: #eee !important; color: black !important; -webkit-print-color-adjust: exact; }
            @page { margin: 1cm; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <aside class="sidebar no-print">
        <div class="logo-section">
            <div class="logo-icon" style="font-size:2rem; color:#667eea;"><i class="fas fa-clipboard-list"></i></div>
            <h2>Quartermaster</h2>
        </div>
        <select id="officeSelect" class="form-select">
            <option value="">-- Choose Office --</option>
        </select>
        <button class="btn btn-primary" id="saveBtn"><i class="fas fa-save"></i> Save Office Data</button>
        <button class="btn btn-success" id="printOfficeBtn" disabled><i class="fas fa-print"></i> Print Office Report</button>
        <button class="btn btn-success" id="totalSummaryBtn"><i class="fas fa-chart-bar"></i> Global Summary</button>
        <button class="btn btn-success" id="printGlobalBtn"><i class="fas fa-print"></i> Print Global Report</button>
        <button class="btn btn-manage" id="manageItemsBtn"><i class="fas fa-sort"></i> Reorder / Add Items</button>
    </aside>

    <main class="main-content no-print">
        <div class="content-header">
            <h2 id="contentTitle">Inventory</h2>
        </div>
        <div style="padding: 2rem; overflow-x: auto;">
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th style="text-align: left;">Item Description</th>
                        <th>TE 2019</th>
                        <th>On Hand</th>
                        <th>TE 2025</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </main>
</div>

<div class="modal" id="manageModal">
    <div class="modal-content" style="max-width: 600px;">
        <h3>Manage Master Items</h3>
        <p style="font-size: 0.8rem; color: #667; margin-bottom: 1rem;">Drag items to reorder. Changes save instantly.</p>
        
        <div style="background: #f1f5f9; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
            <input type="text" id="newItemName" placeholder="Item Name" style="width:100%; padding:0.5rem; margin-bottom:0.5rem;">
            <select id="newItemType" style="width:100%; padding:0.5rem; margin-bottom:0.5rem;">
                <option value="false">Regular Item</option>
                <option value="true">Category Header</option>
            </select>
            <button class="btn btn-primary" onclick="handleAddItem()">Add Item</button>
        </div>

        <div id="dragList" style="border: 1px solid #eee; border-radius: 0.5rem; max-height: 400px; overflow-y: auto;">
        </div>
        <button class="btn btn-manage" style="margin-top:1rem" onclick="closeModal('manageModal')">Close</button>
    </div>
</div>

<div class="modal" id="summaryModal">
    <div class="modal-content">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2>Global Inventory Report</h2>
            <button class="no-print" onclick="closeModal('summaryModal')" style="border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
        </div>

        <div class="summary-grid">
            <div class="summary-card"><div>Global TE 2019</div><h3 id="sum19">0</h3></div>
            <div class="summary-card"><div>Global On Hand</div><h3 id="sumOH">0</h3></div>
            <div class="summary-card"><div>Global TE 2025</div><h3 id="sum25">0</h3></div>
        </div>

        <table class="inventory-table">
            <thead>
                <tr>
                    <th style="text-align: left;">Description</th>
                    <th>Global TE 2019</th>
                    <th>Global On Hand</th>
                    <th>Global TE 2025</th>
                </tr>
            </thead>
            <tbody id="summaryTableBody"></tbody>
        </table>

        <div style="margin-top: 2rem;" class="no-print">
            <button class="btn btn-primary" onclick="window.print()">Print This Report</button>
        </div>
    </div>
</div>

<div class="modal" id="officeReportModal">
    <div class="modal-content">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 id="officeReportTitle">Office Inventory Report</h2>
            <button class="no-print" onclick="closeModal('officeReportModal')" style="border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
        </div>

        <div class="summary-grid">
            <div class="summary-card"><div>TE 2019</div><h3 id="office19">0</h3></div>
            <div class="summary-card"><div>On Hand</div><h3 id="officeOH">0</h3></div>
            <div class="summary-card"><div>TE 2025</div><h3 id="office25">0</h3></div>
        </div>

        <table class="inventory-table">
            <thead>
                <tr>
                    <th style="text-align: left;">Description</th>
                    <th>TE 2019</th>
                    <th>On Hand</th>
                    <th>TE 2025</th>
                </tr>
            </thead>
            <tbody id="officeReportBody"></tbody>
        </table>

        <div style="margin-top: 2rem;" class="no-print">
            <button class="btn btn-primary" onclick="window.print()">Print This Report</button>
        </div>
    </div>
</div>

<script>
const SUPABASE_URL = "https://jdzfxfriydakuqegtahq.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkemZ4ZnJpeWRha3VxZWd0YWhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwODU0MTEsImV4cCI6MjA3NjY2MTQxMX0.8uuX1PUSKOg03AuZeJJ5HxSUhM-gqapTclMn2A3tD4U";
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let masterItems = [];
let officeMap = {};
let currentOfficeId = null;
let currentOfficeData = {};

async function init() {
    await loadOffices();
    await loadMasterItems();
    document.getElementById('officeSelect').onchange = (e) => loadOfficeInventory(e.target.value);
    document.getElementById('saveBtn').onclick = saveCurrentData;
    document.getElementById('printOfficeBtn').onclick = printOfficeReport;
    document.getElementById('totalSummaryBtn').onclick = showGlobalSummary;
    document.getElementById('printGlobalBtn').onclick = generateCompleteSummary;
    document.getElementById('manageItemsBtn').onclick = openManageModal;
    
    // Initialize Drag and Drop
    const el = document.getElementById('dragList');
    Sortable.create(el, {
        animation: 150,
        ghostClass: 'sortable-ghost',
        onEnd: async () => {
            const items = Array.from(el.children).map((child, index) => ({
                id: child.dataset.id,
                display_order: index + 1
            }));
            for (const item of items) {
                await supabaseClient.from('quartermaster_items').update({ display_order: item.display_order }).eq('id', item.id);
            }
            await loadMasterItems();
            if(currentOfficeId) renderMainTable();
        }
    });
}

async function loadOffices() {
    const { data } = await supabaseClient.from('offices').select("*").order('office_name');
    const select = document.getElementById('officeSelect');
    if(data) data.forEach(o => { officeMap[o.id] = o.office_name; select.add(new Option(o.office_name, o.id)); });
}

async function loadMasterItems() {
    const { data } = await supabaseClient.from('quartermaster_items').select("*").order('display_order');
    masterItems = data || [];
}

async function loadOfficeInventory(officeId) {
    if (!officeId) {
        currentOfficeId = null;
        document.getElementById('printOfficeBtn').disabled = true;
        return;
    }
    currentOfficeId = officeId;
    document.getElementById('printOfficeBtn').disabled = false;
    document.getElementById('contentTitle').textContent = officeMap[officeId];
    const { data } = await supabaseClient.from('office_quartermaster').select("*").eq('office_id', officeId);
    currentOfficeData = {};
    (data || []).forEach(row => { currentOfficeData[row.item_id] = { t19: row.te_2019, oh: row.onhand, t25: row.proposed_te_2025 }; });
    renderMainTable();
}

function renderMainTable() {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = "";
    masterItems.forEach(item => {
        const tr = document.createElement('tr');
        if (item.colspan) {
            tr.className = "category-row";
            tr.innerHTML = `<td colspan="4"><i class="fas fa-folder"></i> ${item.item_name}</td>`;
        } else {
            const v = currentOfficeData[item.id] || {t19:0, oh:0, t25:0};
            tr.innerHTML = `
                <td style="text-align: left;">${item.item_name}</td>
                <td><input type="number" class="qty-input" value="${v.t19 || 0}" onchange="updateLocal(${item.id}, 't19', this.value)"></td>
                <td><input type="number" class="qty-input" value="${v.oh || 0}" onchange="updateLocal(${item.id}, 'oh', this.value)"></td>
                <td><input type="number" class="qty-input" value="${v.t25 || 0}" onchange="updateLocal(${item.id}, 't25', this.value)"></td>`;
        }
        tbody.appendChild(tr);
    });
}

function updateLocal(id, f, v) {
    if(!currentOfficeData[id]) currentOfficeData[id] = {t19:0, oh:0, t25:0};
    currentOfficeData[id][f] = parseInt(v) || 0;
}

async function saveCurrentData() {
    if(!currentOfficeId) return alert("Select office.");
    const records = Object.keys(currentOfficeData).map(itemId => ({
        office_id: currentOfficeId, item_id: parseInt(itemId),
        te_2019: currentOfficeData[itemId].t19, onhand: currentOfficeData[itemId].oh,
        proposed_te_2025: currentOfficeData[itemId].t25
    }));
    await supabaseClient.from('office_quartermaster').delete().eq('office_id', currentOfficeId);
    await supabaseClient.from('office_quartermaster').insert(records);
    alert("Saved!");
}

function openManageModal() {
    const list = document.getElementById('dragList');
    list.innerHTML = masterItems.map(i => `
        <div class="sortable-item" data-id="${i.id}">
            <span>${i.colspan ? 'üìÅ ' : ''}${i.item_name}</span>
            <button onclick="deleteMasterItem(${i.id})" style="color:red; background:none; border:none; cursor:pointer;"><i class="fas fa-trash"></i></button>
        </div>`).join('');
    document.getElementById('manageModal').classList.add('show');
}

async function handleAddItem() {
    const name = document.getElementById('newItemName').value;
    const isHeader = document.getElementById('newItemType').value === "true";
    if(!name) return;
    await supabaseClient.from('quartermaster_items').insert([{ item_name: name, colspan: isHeader, display_order: masterItems.length + 1 }]);
    document.getElementById('newItemName').value = "";
    await loadMasterItems();
    openManageModal();
    if(currentOfficeId) renderMainTable();
}

async function deleteMasterItem(id) {
    if(!confirm("Delete item?")) return;
    await supabaseClient.from('quartermaster_items').delete().eq('id', id);
    await loadMasterItems();
    openManageModal();
    if(currentOfficeId) renderMainTable();
}

async function showGlobalSummary() {
    const { data } = await supabaseClient.from('office_quartermaster').select("*");
    const totals = {};
    let g19 = 0, gOH = 0, g25 = 0;
    (data || []).forEach(r => {
        if(!totals[r.item_id]) totals[r.item_id] = { t19:0, oh:0, t25:0 };
        totals[r.item_id].t19 += (r.te_2019 || 0);
        totals[r.item_id].oh += (r.onhand || 0);
        totals[r.item_id].t25 += (r.proposed_te_2025 || 0);
        g19 += (r.te_2019 || 0); gOH += (r.onhand || 0); g25 += (r.proposed_te_2025 || 0);
    });
    document.getElementById('sum19').innerText = g19;
    document.getElementById('sumOH').innerText = gOH;
    document.getElementById('sum25').innerText = g25;
    
    const tbody = document.getElementById('summaryTableBody');
    tbody.innerHTML = "";
    masterItems.forEach(item => {
        const tr = document.createElement('tr');
        if (item.colspan) {
            tr.className = "category-row";
            tr.innerHTML = `<td colspan="4">${item.item_name}</td>`;
        } else {
            const t = totals[item.id] || {t19:0, oh:0, t25:0};
            tr.innerHTML = `<td>${item.item_name}</td><td>${t.t19}</td><td>${t.oh}</td><td>${t.t25}</td>`;
        }
        tbody.appendChild(tr);
    });
    document.getElementById('summaryModal').classList.add('show');
}

async function generateCompleteSummary() {
    await showGlobalSummary();
    // Wait a bit for the modal to render before printing
    setTimeout(() => {
        window.print();
    }, 300);
}

function printOfficeReport() {
    if(!currentOfficeId) return;
    
    let o19 = 0, oOH = 0, o25 = 0;
    Object.values(currentOfficeData).forEach(v => {
        o19 += (v.t19 || 0);
        oOH += (v.oh || 0);
        o25 += (v.t25 || 0);
    });
    
    document.getElementById('officeReportTitle').innerText = `${officeMap[currentOfficeId]} - Inventory Report`;
    document.getElementById('office19').innerText = o19;
    document.getElementById('officeOH').innerText = oOH;
    document.getElementById('office25').innerText = o25;
    
    const tbody = document.getElementById('officeReportBody');
    tbody.innerHTML = "";
    masterItems.forEach(item => {
        const tr = document.createElement('tr');
        if (item.colspan) {
            tr.className = "category-row";
            tr.innerHTML = `<td colspan="4">${item.item_name}</td>`;
        } else {
            const v = currentOfficeData[item.id] || {t19:0, oh:0, t25:0};
            tr.innerHTML = `<td>${item.item_name}</td><td>${v.t19}</td><td>${v.oh}</td><td>${v.t25}</td>`;
        }
        tbody.appendChild(tr);
    });
    document.getElementById('officeReportModal').classList.add('show');
}

function closeModal(id) { document.getElementById(id).classList.remove('show'); }

init();
</script>
</body>
</html>
