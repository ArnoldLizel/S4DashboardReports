<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Quartermaster | Complete Summary System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ORIGINAL DESIGN STYLES */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          padding: 1.5rem;
        }
        .app-container { max-width: 1600px; margin: 0 auto; display: grid; grid-template-columns: 320px 1fr; gap: 1.5rem; align-items: start; }
        .sidebar { background: white; border-radius: 1rem; box-shadow: 0 20px 60px rgba(0,0,0,0.15); padding: 2rem; position: sticky; top: 1.5rem; }
        .logo-section { text-align: center; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 2px solid #f3f4f6; }
        .logo-icon { width: 64px; height: 64px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 1rem; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: white; font-size: 2rem; }
        
        .section { margin-bottom: 2rem; }
        .section-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #9ca3af; font-weight: 700; margin-bottom: 1rem; }
        .form-select { width: 100%; padding: 0.75rem 1rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; font-size: 0.95rem; background: white; cursor: pointer; }
        
        /* SEARCH BAR */
        .search-container { padding: 0 2rem; margin: 1.5rem 0; position: relative; }
        .search-input { width: 100%; padding: 0.8rem 1rem 0.8rem 2.8rem; border: 2px solid #667eea; border-radius: 0.5rem; font-size: 1rem; outline: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .search-icon { position: absolute; left: 3rem; top: 50%; transform: translateY(-50%); color: #667eea; }

        /* BUTTONS */
        .action-buttons { display: grid; gap: 0.75rem; }
        .btn { padding: 0.75rem 1rem; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: 0.2s; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-outline { background: white; color: #667eea; border: 2px solid #667eea; }
        .btn-manage { background: #f8fafc; color: #475569; border: 1px solid #e2e8f0; }

        /* TABLE AREA */
        .main-content { background: white; border-radius: 1rem; box-shadow: 0 20px 60px rgba(0,0,0,0.15); overflow: hidden; }
        .content-header { padding: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .inventory-table-wrapper { padding: 2rem; max-height: calc(100vh - 280px); overflow-y: auto; }
        .inventory-table { width: 100%; border-collapse: collapse; }
        .inventory-table th { padding: 1rem; background: #f9fafb; text-align: center; font-size: 0.8rem; border-bottom: 2px solid #e5e7eb; position: sticky; top: 0; z-index: 10; }
        .inventory-table td { padding: 0.8rem; border-bottom: 1px solid #f3f4f6; text-align: center; }
        .category-row td { background: #667eea !important; color: white !important; text-align: left !important; font-weight: bold; }
        .qty-input { width: 80px; padding: 0.4rem; text-align: center; border: 1px solid #ddd; border-radius: 4px; font-weight: bold; }

        /* MODAL & SUMMARY */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 1rem; padding: 2rem; width: 95%; max-width: 1000px; max-height: 90vh; overflow-y: auto; }
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem; }
        .summary-card { padding: 1.5rem; border-radius: 0.75rem; background: #f8fafc; border-bottom: 4px solid #10b981; text-align: center; }

        /* MANAGE MODAL SPECIFICS */
        .input-group { margin-bottom: 1rem; text-align: left; }
        .input-group label { display: block; font-size: 0.8rem; font-weight: 700; margin-bottom: 0.3rem; color: #64748b; }
        .input-group input, .input-group select { width: 100%; padding: 0.7rem; border: 1px solid #e2e8f0; border-radius: 0.4rem; }

        /* PRINT */
        @media print {
            .sidebar, .no-print, .search-container, .btn-close-modal { display: none !important; }
            body { background: white !important; padding: 0; }
            .modal { position: absolute; display: block; background: white; inset: 0; }
            .modal-content { width: 100%; max-width: 100%; box-shadow: none; padding: 0; }
            .inventory-table-wrapper { max-height: none; overflow: visible; }
            .inventory-table th { background: #eee !important; color: black !important; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <aside class="sidebar">
        <div class="logo-section">
            <div class="logo-icon"><i class="fas fa-boxes"></i></div>
            <h1>Quartermaster</h1>
            <p>Admin Console</p>
        </div>

        <div class="section">
            <div class="section-title">Select Office</div>
            <select id="officeSelect" class="form-select">
                <option value="">-- Choose Office --</option>
            </select>
        </div>

        <div class="section">
            <div class="section-title">Actions</div>
            <div class="action-buttons">
                <button class="btn btn-primary" id="saveBtn"><i class="fas fa-save"></i> Save Current</button>
                <button class="btn btn-success" id="totalSummaryBtn"><i class="fas fa-file-invoice"></i> Complete Summary</button>
                <button class="btn btn-manage" id="manageItemsBtn"><i class="fas fa-cog"></i> Manage Master List</button>
                <button class="btn btn-outline" onclick="location.reload()"><i class="fas fa-sync"></i> Refresh App</button>
            </div>
        </div>
    </aside>

    <main class="main-content">
        <div class="content-header">
            <h2 id="contentTitle">Inventory Overview</h2>
            <p id="contentSubtitle">Real-time Equipment Tracking</p>
        </div>

        <div class="search-container no-print">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="tableSearch" class="search-input" placeholder="Search item name..." onkeyup="filterItems()">
        </div>

        <div class="inventory-table-wrapper">
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th style="text-align: left; width: 45%;">Item Description</th>
                        <th>TE 2019</th>
                        <th>On Hand</th>
                        <th>TE 2025</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="4" style="padding: 3rem; color: #999;">Select an office to begin.</td></tr>
                </tbody>
            </table>
        </div>
    </main>
</div>

<div class="modal" id="manageModal">
    <div class="modal-content" style="max-width: 600px;">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h2>Manage Master Items</h2>
            <button style="background:none; border:none; font-size: 1.5rem; cursor:pointer;" onclick="closeManageModal()">&times;</button>
        </div>

        <div style="background: #f8fafc; padding: 1.5rem; border-radius: 0.8rem; margin-bottom: 2rem;">
            <h4 style="margin-bottom:1rem">Add New Entry</h4>
            <div class="input-group">
                <label>Name</label>
                <input type="text" id="newItemName" placeholder="e.g. Laptop, Dell Latitude">
            </div>
            <div class="input-group">
                <label>Entry Type</label>
                <select id="newItemType">
                    <option value="false">Regular Item</option>
                    <option value="true">Category Header</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="handleAddItem()" style="width:100%">Add to Master List</button>
        </div>

        <h4 style="margin-bottom:1rem">Current Items</h4>
        <div id="masterListScroll" style="max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 0.5rem;">
            </div>
    </div>
</div>

<div class="modal" id="summaryModal">
    <div class="modal-content">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h2>Complete Global Inventory Report</h2>
            <button class="btn-close-modal" style="background:none; border:none; font-size: 1.5rem; cursor:pointer;" onclick="closeModal()">&times;</button>
        </div>

        <div class="summary-grid">
            <div class="summary-card">
                <div style="font-size: 0.8rem; text-transform: uppercase; color: #64748b;">Global TE 2019</div>
                <div id="sum19" style="font-size: 1.8rem; font-weight: 800;">0</div>
            </div>
            <div class="summary-card" style="border-bottom-color: #667eea;">
                <div style="font-size: 0.8rem; text-transform: uppercase; color: #64748b;">Global On Hand</div>
                <div id="sumOH" style="font-size: 1.8rem; font-weight: 800;">0</div>
            </div>
            <div class="summary-card">
                <div style="font-size: 0.8rem; text-transform: uppercase; color: #64748b;">Global TE 2025</div>
                <div id="sum25" style="font-size: 1.8rem; font-weight: 800;">0</div>
            </div>
        </div>

        <h3 style="margin-bottom: 1rem; border-bottom: 2px solid #eee; padding-bottom: 0.5rem;">Detailed Item Breakdown</h3>
        <table class="inventory-table" style="font-size: 0.9rem;">
            <thead>
                <tr>
                    <th style="text-align: left;">Item Description</th>
                    <th>Global TE 2019</th>
                    <th>Global On Hand</th>
                    <th>Global TE 2025</th>
                </tr>
            </thead>
            <tbody id="summaryTableBody"></tbody>
        </table>

        <div style="margin-top: 2rem; display: flex; gap: 1rem;" class="no-print">
            <button class="btn btn-primary" style="flex: 1;" onclick="window.print()"><i class="fas fa-print"></i> Print Full Report</button>
            <button class="btn btn-outline" onclick="closeModal()">Close</button>
        </div>
    </div>
</div>

<script>
const SUPABASE_URL = "https://jdzfxfriydakuqegtahq.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkemZ4ZnJpeWRha3VxZWd0YWhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwODU0MTEsImV4cCI6MjA3NjY2MTQxMX0.8uuX1PUSKOg03AuZeJJ5HxSUhM-gqapTclMn2A3tD4U";
const T_OFFICES = "offices";
const T_ITEMS = "quartermaster_items";
const T_DATA = "office_quartermaster";
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let masterItems = [];
let officeMap = {};
let currentOfficeId = null;
let currentOfficeData = {};

async function init() {
    await loadOffices();
    await loadMasterItems();
    document.getElementById('officeSelect').addEventListener('change', e => loadOfficeInventory(e.target.value));
    document.getElementById('saveBtn').addEventListener('click', saveCurrentData);
    document.getElementById('totalSummaryBtn').addEventListener('click', generateCompleteSummary);
    document.getElementById('manageItemsBtn').addEventListener('click', openManageModal);
}

async function loadOffices() {
    const { data } = await supabaseClient.from(T_OFFICES).select("id, office_name").order('office_name');
    const select = document.getElementById('officeSelect');
    if(data) {
        data.forEach(o => {
            officeMap[o.id] = o.office_name;
            select.add(new Option(o.office_name, o.id));
        });
    }
}

async function loadMasterItems() {
    const { data } = await supabaseClient.from(T_ITEMS).select("*").order('display_order');
    masterItems = data || [];
}

async function loadOfficeInventory(officeId) {
    if (!officeId) return;
    currentOfficeId = officeId;
    document.getElementById('contentTitle').textContent = officeMap[officeId];
    
    const { data } = await supabaseClient.from(T_DATA).select("*").eq('office_id', officeId);
    currentOfficeData = {};
    (data || []).forEach(row => {
        currentOfficeData[row.item_id] = { t19: row.te_2019 || 0, oh: row.onhand || 0, t25: row.proposed_te_2025 || 0 };
    });
    renderMainTable();
}

function renderMainTable() {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = "";
    masterItems.forEach(item => {
        const tr = document.createElement('tr');
        if (item.colspan) {
            tr.className = "category-row";
            tr.innerHTML = `<td colspan="4"><i class="fas fa-folder"></i> ${item.item_name}</td>`;
        } else {
            const val = currentOfficeData[item.id] || {t19:0, oh:0, t25:0};
            tr.innerHTML = `
                <td class="item-name" style="text-align: left; font-weight: 600;">${item.item_name}</td>
                <td><input type="number" class="qty-input" value="${val.t19}" onchange="updateLocal(${item.id}, 't19', this.value)"></td>
                <td><input type="number" class="qty-input" value="${val.oh}" onchange="updateLocal(${item.id}, 'oh', this.value)"></td>
                <td><input type="number" class="qty-input" value="${val.t25}" onchange="updateLocal(${item.id}, 't25', this.value)"></td>
            `;
        }
        tbody.appendChild(tr);
    });
}

function updateLocal(id, field, val) {
    if(!currentOfficeData[id]) currentOfficeData[id] = {t19:0, oh:0, t25:0};
    currentOfficeData[id][field] = parseInt(val) || 0;
}

async function saveCurrentData() {
    if(!currentOfficeId) return alert("Select an office first.");
    const records = Object.keys(currentOfficeData).map(itemId => ({
        office_id: currentOfficeId,
        item_id: parseInt(itemId),
        te_2019: currentOfficeData[itemId].t19,
        onhand: currentOfficeData[itemId].oh,
        proposed_te_2025: currentOfficeData[itemId].t25
    }));
    await supabaseClient.from(T_DATA).delete().eq('office_id', currentOfficeId);
    await supabaseClient.from(T_DATA).insert(records);
    alert("Office data saved successfully!");
}

// MANAGEMENT FUNCTIONS
function openManageModal() {
    renderMasterManager();
    document.getElementById('manageModal').classList.add('show');
}

function closeManageModal() {
    document.getElementById('manageModal').classList.remove('show');
}

function renderMasterManager() {
    const container = document.getElementById('masterListScroll');
    container.innerHTML = masterItems.map(item => `
        <div style="display:flex; justify-content:space-between; padding: 0.8rem; border-bottom: 1px solid #f1f5f9; align-items:center; background:${item.colspan ? '#f8fafc' : 'white'}">
            <span style="${item.colspan ? 'font-weight:bold; color:#667eea' : ''}">${item.colspan ? 'üìÅ ' : ''}${item.item_name}</span>
            <button onclick="handleDeleteItem(${item.id})" style="color:#ef4444; border:none; background:none; cursor:pointer;"><i class="fas fa-trash"></i></button>
        </div>
    `).join('');
}

async function handleAddItem() {
    const name = document.getElementById('newItemName').value;
    const isHeader = document.getElementById('newItemType').value === "true";
    if(!name) return alert("Please enter a name");

    const { error } = await supabaseClient.from(T_ITEMS).insert([{
        item_name: name,
        colspan: isHeader,
        display_order: masterItems.length + 1
    }]);

    if(error) alert(error.message);
    else {
        document.getElementById('newItemName').value = "";
        await loadMasterItems();
        renderMasterManager();
        if(currentOfficeId) renderMainTable();
    }
}

async function handleDeleteItem(id) {
    if(!confirm("Remove this item? This affects all offices.")) return;
    const { error } = await supabaseClient.from(T_ITEMS).delete().eq('id', id);
    if(error) alert(error.message);
    else {
        await loadMasterItems();
        renderMasterManager();
        if(currentOfficeId) renderMainTable();
    }
}

function filterItems() {
    const filter = document.getElementById('tableSearch').value.toLowerCase();
    const rows = document.querySelectorAll('#tableBody tr');
    rows.forEach(row => {
        if (row.classList.contains('category-row')) return;
        const text = row.querySelector('.item-name').textContent.toLowerCase();
        row.style.display = text.includes(filter) ? "" : "none";
    });
}

async function generateCompleteSummary() {
    const { data } = await supabaseClient.from(T_DATA).select("*");
    const totalsByItem = {};
    let global19 = 0, globalOH = 0, global25 = 0;

    (data || []).forEach(row => {
        if (!totalsByItem[row.item_id]) totalsByItem[row.item_id] = { t19: 0, oh: 0, t25: 0 };
        totalsByItem[row.item_id].t19 += (row.te_2019 || 0);
        totalsByItem[row.item_id].oh += (row.onhand || 0);
        totalsByItem[row.item_id].t25 += (row.proposed_te_2025 || 0);
        global19 += (row.te_2019 || 0);
        globalOH += (row.onhand || 0);
        global25 += (row.proposed_te_2025 || 0);
    });

    document.getElementById('sum19').textContent = global19.toLocaleString();
    document.getElementById('sumOH').textContent = globalOH.toLocaleString();
    document.getElementById('sum25').textContent = global25.toLocaleString();

    const sumTbody = document.getElementById('summaryTableBody');
    sumTbody.innerHTML = "";
    masterItems.forEach(item => {
        const tr = document.createElement('tr');
        if (item.colspan) {
            tr.className = "category-row";
            tr.innerHTML = `<td colspan="4">${item.item_name}</td>`;
        } else {
            const t = totalsByItem[item.id] || { t19: 0, oh: 0, t25: 0 };
            tr.innerHTML = `
                <td style="text-align: left;">${item.item_name}</td>
                <td>${t.t19}</td>
                <td><strong style="color: #10b981;">${t.oh}</strong></td>
                <td>${t.t25}</td>
            `;
        }
        sumTbody.appendChild(tr);
    });
    document.getElementById('summaryModal').classList.add('show');
}

function closeModal() { document.getElementById('summaryModal').classList.remove('show'); }

init();
</script>
</body>
</html>
