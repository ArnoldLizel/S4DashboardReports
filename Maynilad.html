<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Water Bill - Philippine Navy</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
    body {
        background-image: url('image/bg2.jpg');
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        background-repeat: no-repeat;
        min-height: 100vh;
    }

    .container {
        background-color: rgba(255, 255, 255, 0.9); 
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f3f4f6;
      color: #1f2937;
      line-height: 1.6;
      min-height: 100vh;
    }

    h1 { color: #0b1a3a; font-weight: 600; margin-bottom: 1rem; font-size: 2rem; }

    .header-wrapper {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .action-buttons { display: flex; gap: 1rem; }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      font-weight: 600;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-save { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
    .btn-save:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); }
    .btn-save:disabled { background: #9ca3af; cursor: not-allowed; transform: none; }

    .btn-print { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; }
    .btn-print:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(30, 58, 138, 0.4); }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 600;
      z-index: 1000;
      animation: slideIn 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .notification.success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
    .notification.error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }

    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .summary-card {
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      border: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .summary-icon { width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; flex-shrink: 0; }
    .summary-value { font-size: 1.75rem; font-weight: 700; color: #0b1a3a; margin-top: 0.25rem; }

    .table-responsive { overflow-x: auto; margin-bottom: 1.5rem; }
    .table { width: 100%; border-collapse: collapse; background-color: white; font-size: 0.875rem; }
    .table thead { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; }
    .table thead th { padding: 0.875rem 1rem; text-align: center; text-transform: uppercase; border-bottom: 2px solid #06b6d4; }
    .table tbody td { padding: 0.875rem 1rem; text-align: center; border-bottom: 1px solid #e5e7eb; }
    .table tbody td[contenteditable="true"] { background-color: #f9fafb; cursor: text; }
    .table tfoot { background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%); color: white; font-weight: 700; }

    .chart-container { position: relative; height: 400px; margin-bottom: 1.5rem; }
    .collapse-section { background: white; border-radius: 0.5rem; border: 1px solid #e5e7eb; margin-bottom: 1.5rem; overflow: hidden; }
    .collapse-toggle { width: 100%; padding: 1rem 1.5rem; background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; border: none; cursor: pointer; display: flex; justify-content: space-between; font-weight: 600; }
    .collapse-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
    .collapse-content.open { max-height: 600px; }

    @media print { .no-print { display: none !important; } .container { background: white; padding: 0; } }
</style>
</head>
<body>

<div class="container">
  <div class="header-wrapper">
    <h1>üíß Water Bill (Maynilad)</h1>
    <div class="action-buttons no-print">
      <button class="btn btn-save" id="saveBtn"><span>üíæ</span><span>Save All Data</span></button>
      <button class="btn btn-print" id="printBtn"><span>üñ®Ô∏è</span><span>Print</span></button>
    </div>
  </div>

  <div class="summary-grid">
    <div class="summary-card">
      <div class="summary-icon" style="background: #1e3a8a; color: white;">üíß</div>
      <div class="summary-info">
        <div class="summary-label">Total m¬≥ Consumed</div>
        <div class="summary-value" id="summaryTotalCubic">0</div>
      </div>
    </div>
    <div class="summary-card">
      <div class="summary-icon" style="background: #ef4444; color: white;">üí∞</div>
      <div class="summary-info">
        <div class="summary-label">Total Amount (PHP)</div>
        <div class="summary-value" id="summaryTotalAmount">‚Ç±0</div>
      </div>
    </div>
    <div class="summary-card">
      <div class="summary-icon" style="background: #0f766e; color: white;">üìä</div>
      <div class="summary-info">
        <div class="summary-label">Average m¬≥/Month</div>
        <div class="summary-value" id="summaryAvgCubic">0</div>
      </div>
    </div>
    <div class="summary-card">
      <div class="summary-icon" style="background: #f59e0b; color: white;">üíµ</div>
      <div class="summary-info">
        <div class="summary-label">Avg. Amount/Month (PHP)</div>
        <div class="summary-value" id="summaryAvgAmount">‚Ç±0</div>
      </div>
    </div>
  </div>

  <div class="collapse-section no-print">
    <button class="collapse-toggle" id="chartToggle">
      <span>üìà Monthly Water Consumption Chart</span>
      <span id="chartArrow">‚ñº</span>
    </button>
    <div class="collapse-content" id="chartContent">
      <div style="padding: 1.5rem;"><div class="chart-container"><canvas id="waterChart"></canvas></div></div>
    </div>
  </div>

  <div class="card">
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Month</th>
            <th>Location</th>
            <th>Per m¬≥ (PHP)</th>
            <th>Total m¬≥/Month</th>
            <th>Amount PHP/Month</th>
          </tr>
        </thead>
        <tbody id="billTableBody"></tbody>
        <tfoot>
          <tr>
            <td colspan="3">TOTAL</td>
            <td id="totalCubic">0</td>
            <td id="totalAmount">0</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>

<script>
(() => {
  const SUPABASE_URL = "https://jdzfxfriydakuqegtahq.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkemZ4ZnJpeWRha3VxZWd0YWhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwODU0MTEsImV4cCI6MjA3NjY2MTQxMX0.8uuX1PUSKOg03AuZeJJ5HxSUhM-gqapTclMn2A3tD4U";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  
  const months = ["09 JAN - 09 FEB", "09 FEB - 09 MAR", "09 MAR - 09 APR", "09 APR - 09 MAY", "09 MAY - 09 JUN", "09 JUN - 09 JUL", "09 JUL - 09 AUG", "09 AUG - 09 SEP", "09 SEP - 09 OCT", "09 OCT - 09 NOV", "09 NOV - 09 DEC", "09 DEC - 09 JAN"];
  const monthLabels = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
  const tbody = document.getElementById("billTableBody");
  const saveBtn = document.getElementById("saveBtn");
  let currentYear = new Date().getFullYear().toString();
  let chart = null;
  let waterData = [];

  function showNotification(message, type = 'success') {
    const n = document.createElement('div');
    n.className = `notification ${type}`;
    n.textContent = message;
    document.body.appendChild(n);
    setTimeout(() => { n.style.animation = 'slideIn 0.3s ease reverse'; setTimeout(() => n.remove(), 300); }, 3000);
  }

  const renderTable = () => {
    tbody.innerHTML = "";
    months.forEach((month, idx) => {
      const row = document.createElement("tr");
      const saved = waterData[idx] || {};
      
      const perCubicValue = (saved.perCubic !== undefined && saved.perCubic !== null) 
                            ? saved.perCubic.toString() 
                            : '';

      row.innerHTML = `
        <td><strong>${month}</strong></td>
        <td contenteditable="true">${saved.location || 'HPN, NSJA'}</td>
        <td contenteditable="true" class="per-cubic-cell">${perCubicValue}</td>
        <td contenteditable="true">${saved.totalCubic || ''}</td>
        <td class="amount">${saved.amount || ''}</td>
      `;
      row.dataset.monthIndex = idx;
      tbody.appendChild(row);
    });
    computeTotals();
    updateChart();
  };

  const computeTotals = () => {
    let totalCubic = 0, totalAmount = 0, validMonths = 0;
    
    tbody.querySelectorAll("tr").forEach(row => {
        const cells = row.children;
        const perCubicText = cells[2].innerText.trim();
        const cubicText = cells[3].innerText.trim();
        
        const perCubic = perCubicText === '' ? 0 : parseFloat(perCubicText);
        const cubic = cubicText === '' ? 0 : parseFloat(cubicText);
        
        const amount = cubic * perCubic;
        cells[4].innerText = amount > 0 ? amount.toFixed(2) : '';
        
        totalCubic += cubic;
        totalAmount += amount;
        if (cubic > 0) validMonths++;
    });
    
    document.getElementById("totalCubic").innerText = totalCubic.toFixed(2);
    document.getElementById("totalAmount").innerText = totalAmount.toFixed(2);
    document.getElementById("summaryTotalCubic").innerText = totalCubic.toFixed(2);
    document.getElementById("summaryTotalAmount").innerText = '‚Ç±' + totalAmount.toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    document.getElementById("summaryAvgCubic").innerText = validMonths > 0 ? (totalCubic / validMonths).toFixed(2) : '0';
    document.getElementById("summaryAvgAmount").innerText = validMonths > 0 ? '‚Ç±' + (totalAmount / validMonths).toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '‚Ç±0';
  };

  tbody.addEventListener("keydown", e => {
    if (e.target.classList.contains("per-cubic-cell")) {
        if (['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab'].includes(e.key)) return;
        if (!e.key.match(/[0-9.]/)) {
            e.preventDefault();
            return;
        }
        const text = e.target.innerText;
        if (e.key === '.' && text.includes('.')) {
            e.preventDefault();
            return;
        }
        if (text.includes('.') && text.split('.')[1].length >= 6 && e.key.match(/[0-9]/)) {
            e.preventDefault();
        }
    }
  });

  tbody.addEventListener("input", e => {
    computeTotals();
    updateChart();
  });

  const updateChart = () => {
    const cubicData = [], amountData = [];
    tbody.querySelectorAll("tr").forEach(row => {
      cubicData.push(parseFloat(row.cells[3].innerText) || 0);
      amountData.push(parseFloat(row.cells[4].innerText) || 0);
    });
    if (chart) {
      chart.data.datasets[0].data = cubicData;
      chart.data.datasets[1].data = amountData;
      chart.update();
    } else {
      const ctx = document.getElementById('waterChart');
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: monthLabels,
          datasets: [
            { label: 'm¬≥ Consumption', data: cubicData, backgroundColor: 'rgba(59, 130, 246, 0.8)', yAxisID: 'y' },
            { label: 'Amount (PHP)', data: amountData, borderColor: 'rgba(239, 68, 68, 1)', type: 'line', yAxisID: 'y1' }
          ]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { position: 'left' }, y1: { position: 'right', grid: { drawOnChartArea: false } } } }
      });
    }
  };

  document.getElementById('chartToggle').addEventListener('click', () => {
    document.getElementById('chartContent').classList.toggle('open');
    document.getElementById('chartArrow').innerText = document.getElementById('chartContent').classList.contains('open') ? '‚ñ≤' : '‚ñº';
    if (chart) setTimeout(() => chart.resize(), 300);
  });

  saveBtn.addEventListener('click', async () => {
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span>‚è≥</span><span>Saving...</span>';
    try {
      const dataToSave = [];
      tbody.querySelectorAll("tr").forEach((row, idx) => {
        const cells = row.children;
        const perCubicText = cells[2].innerText.trim();
        
        dataToSave.push({
          year: currentYear, 
          month: months[idx], 
          month_index: idx,
          location: cells[1].innerText.trim(),
          per_cubic: perCubicText === "" ? null : perCubicText,
          total_cubic: parseFloat(cells[3].innerText) || null,
          amount: parseFloat(cells[4].innerText) || null,
          updated_at: new Date().toISOString()
        });
      });
      const { error } = await supabase.from('water_bills').upsert(dataToSave, { onConflict: 'year,month_index' });
      if (error) throw error;
      showNotification('‚úÖ Saved successfully!');
    } catch (err) { 
      showNotification('‚ùå Error: ' + err.message, 'error'); 
    } finally { 
      saveBtn.disabled = false; 
      saveBtn.innerHTML = '<span>üíæ</span><span>Save All Data</span>'; 
    }
  });

  document.getElementById('printBtn').addEventListener('click', () => window.print());

  async function loadData(year) {
    const { data, error } = await supabase.from('water_bills').select('*').eq('year', year).order('month_index');
    if (error) {
      console.error('Error loading data:', error);
      showNotification('‚ö†Ô∏è Error loading data: ' + error.message, 'error');
    }
    if (data) {
      waterData = new Array(12).fill(null);
      data.forEach(r => { 
        // Handle per_cubic as string to preserve decimals
        let perCubicValue = '';
        if (r.per_cubic !== null && r.per_cubic !== undefined) {
          // Check if it's already a string or convert it
          perCubicValue = typeof r.per_cubic === 'string' ? r.per_cubic : r.per_cubic.toString();
        }
        
        waterData[r.month_index] = { 
          location: r.location, 
          perCubic: perCubicValue,
          totalCubic: r.total_cubic, 
          amount: r.amount 
        }; 
      });
      renderTable();
    }
  }

  // Check database schema on load
  async function checkDatabaseSchema() {
    console.log('üí° IMPORTANT: Make sure your Supabase "per_cubic" column is set to TEXT type, not NUMERIC!');
    console.log('To fix this in Supabase:');
    console.log('1. Go to Table Editor ‚Üí water_bills table');
    console.log('2. Click on "per_cubic" column');
    console.log('3. Change type from "numeric" to "text"');
    console.log('4. Save changes');
  }

  checkDatabaseSchema();
  renderTable();
  loadData(currentYear);
})();
</script>
</body>
</html>
